{% load static %}
{% load crispy_forms_tags %}
<button class="feedback-tab btn btn-info btn-sm text-nowrap shadow-sm"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#feedbackOffcanvas"
        aria-label="Send Feedback">
    <i class="fa-solid fa-envelope"></i>
    Send Feedback
</button>
<div class="offcanvas offcanvas-end"
    tabindex="-1"
    id="feedbackOffcanvas"
    aria-labelledby="feedbackOffcanvasLabel"
    style="width: 500px; max-width: 90vw"
    {# djlint:off #}
     x-data="{
        screenshotPreview: null,
        isSubmitting: false,
        handleScreenshotChange(event) {
          const file = event.target.files[0];
          if (file) {
            if (file.size > 5 * 1024 * 1024) {
              alert('File size must be less than 5MB');
              event.target.value = '';
              this.screenshotPreview = null;
              return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
              this.screenshotPreview = e.target.result;
            };
            reader.readAsDataURL(file);
          } else {
            this.screenshotPreview = null;
          }
        },
        getBrowserInfo() {
          const nav = navigator;
          return nav.userAgent + ' | Screen: ' + screen.width + 'x' + screen.height;
        }
     }"
    {# djlint:on #}
    >
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title" id="feedbackOffcanvasLabel">Send Feedback</h5>
        <button type="button"
                class="btn-close"
                data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form id="feedbackForm"
              method="post"
              enctype="multipart/form-data"
              hx-post="{% url 'feedback:submit' %}"
              hx-target="#feedbackFormContainer"
              hx-swap="innerHTML"
              @submit="isSubmitting = true"
              novalidate>
            {% csrf_token %}
            <div id="feedbackFormContainer">
                {% include 'feedback/feedback_form_fields.html' with form=feedback_form %}
            </div>
        </form>
    </div>
    <script>
        // Handle successful submission
        document.body.addEventListener('feedbackSubmitted', function() {
            const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('feedbackOffcanvas'));
            if (offcanvas) offcanvas.hide();
        });

        // Reset submitting state after HTMX swap (on form errors)
        document.body.addEventListener('htmx:afterSwap', (event) => {
            if (event.target.id === 'feedbackFormContainer') {
                const offcanvas = event.target.closest('.offcanvas');
                const alpineData = Alpine.$data(offcanvas);
                if (alpineData && alpineData.isSubmitting) {
                    alpineData.isSubmitting = false;
                }
            }
        });

        // Position feedback button to the left of scrollbar
        (function() {
            const position = () => {
                const btn = document.querySelector('.feedback-tab');
                const container = document.querySelector('.main-scroll-container');
                if (!btn || !container) return;
                btn.style.right = (container.offsetWidth - container.clientWidth) + 'px';
            };

            ['DOMContentLoaded', 'load', 'resize'].forEach(e => window.addEventListener(e, position));
            document.body.addEventListener('htmx:afterSwap', position);
        })();
    </script>
</div>
