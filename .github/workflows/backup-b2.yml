name: Backup to Backblaze B2

on:
  schedule:
    # Run daily at 9:00 UTC (12:00 PM Israel time, ~1 hour after primary backup)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual triggering for testing

env:
  GDRIVE_REMOTE: ${{ secrets.GDRIVE_REMOTE }}
  B2_BUCKET: ${{ secrets.B2_BUCKET_NAME }}

jobs:
  copy-backups-to-b2:
    name: Copy backups from Google Drive to Backblaze B2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (for retention policy logic reference)
        uses: actions/checkout@v4

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Configure rclone for Google Drive
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_CONTENT }}" | base64 -d > ~/.config/rclone/rclone.conf

          if ! grep -q "^\[gdrive\]" ~/.config/rclone/rclone.conf; then
            echo "::error::Config missing [gdrive] section!"
            exit 1
          fi

      - name: Configure rclone for Backblaze B2
        run: |
          cat >> ~/.config/rclone/rclone.conf <<EOF

          [b2]
          type = b2
          account = ${{ secrets.B2_APPLICATION_KEY_ID }}
          key = ${{ secrets.B2_APPLICATION_KEY }}
          hard_delete = false
          EOF

      - name: Run backup sync to B2
        id: sync
        run: |
          python3 scripts/sync_to_b2.py "${{ env.GDRIVE_REMOTE }}/prod/" "b2:${{ env.B2_BUCKET }}/prod/"

      - name: Verify and report
        id: verify
        run: |
          B2_COUNT=$(rclone lsf b2:${{ env.B2_BUCKET }}/prod/ 2>/dev/null | grep '^backup_' | wc -l)
          LATEST_BACKUP=$(rclone lsf ${{ env.GDRIVE_REMOTE }}/prod/ --files-only | grep '^backup_' | sort -r | head -1)

          echo "b2_count=$B2_COUNT" >> $GITHUB_OUTPUT
          echo "latest_backup=$LATEST_BACKUP" >> $GITHUB_OUTPUT

          echo "Total backups in B2: $B2_COUNT"

          B2_SIZE=$(rclone size b2:${{ env.B2_BUCKET }}/prod/ --json | python3 -c "import sys, json; print(json.load(sys.stdin)['bytes'])")
          B2_SIZE_MB=$((B2_SIZE / 1024 / 1024))
          echo "B2 storage: ${B2_SIZE_MB} MB"

          if [ $B2_SIZE_MB -gt 1000 ]; then
            echo "::warning::B2 storage over 1GB (${B2_SIZE_MB} MB)"
          fi

      - name: Send notification on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_body = `## Backup Copy to B2 Failed

            The scheduled backup copy from Google Drive to Backblaze B2 has failed.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Time:** ${new Date().toISOString()}

            Please investigate the workflow logs and ensure:
            - Google Drive credentials (RCLONE_CONFIG_CONTENT) are valid
            - Backblaze B2 credentials (B2_APPLICATION_KEY_ID, B2_APPLICATION_KEY) are valid
            - B2_BUCKET_NAME secret is set correctly
            - Network connectivity is working
            - Storage quota is not exceeded

            This is an automated notification.`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Backup Copy to B2 Failed',
              body: issue_body,
              labels: ['backup', 'alert', 'infrastructure']
            });

      - name: Generate summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # Backup Copy to B2 Summary

          ## Status

          | Action | Status |
          |--------|--------|
          | Copy latest backup to B2 | ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }} |

          ## Details

          | Item | Value |
          |------|-------|
          | Latest backup copied | \`${{ steps.verify.outputs.latest_backup }}\` |
          | B2 backups (after sync) | ${{ steps.verify.outputs.b2_count }} |

          **Completed:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ---
