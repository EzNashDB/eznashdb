name: Backup to Backblaze B2

on:
  # schedule:
  #   # Run daily at 9:00 UTC (12:00 PM Israel time, ~1 hour after primary backup)
  #   - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual triggering for testing

env:
  GDRIVE_REMOTE: ${{ secrets.GDRIVE_REMOTE }}
  B2_BUCKET: ${{ secrets.B2_BUCKET_NAME }}

jobs:
  copy-backups-to-b2:
    name: Copy backups from Google Drive to Backblaze B2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (for retention policy logic reference)
        uses: actions/checkout@v4

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Configure rclone for Google Drive
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_CONTENT }}" > ~/.config/rclone/rclone.conf

      - name: Configure rclone for Backblaze B2
        run: |
          cat >> ~/.config/rclone/rclone.conf <<EOF

          [b2]
          type = s3
          provider = Other
          access_key_id = ${{ secrets.B2_APPLICATION_KEY_ID }}
          secret_access_key = ${{ secrets.B2_APPLICATION_KEY }}
          endpoint = ${{ secrets.B2_ENDPOINT }}
          acl = private
          EOF

      - name: Find latest backup in Google Drive
        id: find_latest
        run: |
          echo "=== Finding Latest Backup in Google Drive ==="

          # List all backups and find the most recent one
          LATEST_BACKUP=$(rclone lsf ${{ env.GDRIVE_REMOTE }}/prod/ --files-only | grep '^backup_' | sort -r | head -1)

          if [ -z "$LATEST_BACKUP" ]; then
            echo "::warning::No backups found in Google Drive"
            echo "latest_backup=" >> $GITHUB_OUTPUT
            echo "has_backup=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Latest backup: $LATEST_BACKUP"
          echo "latest_backup=$LATEST_BACKUP" >> $GITHUB_OUTPUT
          echo "has_backup=true" >> $GITHUB_OUTPUT

      - name: Copy latest backup to B2
        if: steps.find_latest.outputs.has_backup == 'true'
        run: |
          LATEST_BACKUP="${{ steps.find_latest.outputs.latest_backup }}"
          echo "Copying latest backup to Backblaze B2: $LATEST_BACKUP"

          # Copy only the latest backup from Google Drive to B2
          rclone copy \
            "${{ env.GDRIVE_REMOTE }}/prod/$LATEST_BACKUP" \
            "b2:${{ env.B2_BUCKET }}/prod/" \
            --progress \
            --checksum \
            --log-level INFO

          echo "âœ“ Successfully copied: $LATEST_BACKUP"

      - name: List backups in B2 (before retention)
        id: list_b2_before
        run: |
          echo "=== Backups in B2 (before retention policy) ==="
          B2_COUNT_BEFORE=$(rclone lsf b2:${{ env.B2_BUCKET }}/prod/ 2>/dev/null | wc -l)
          echo "b2_count_before=$B2_COUNT_BEFORE" >> $GITHUB_OUTPUT
          echo "Total: $B2_COUNT_BEFORE backups in B2"

      - name: Apply retention policy to B2
        run: |
          python3 scripts/b2_retention.py "b2:${{ env.B2_BUCKET }}/prod/"

      - name: Verify final backup counts
        id: verify
        run: |
          echo "=== Final Backup Counts ==="

          LATEST_BACKUP="${{ steps.find_latest.outputs.latest_backup }}"
          B2_COUNT=$(rclone lsf b2:${{ env.B2_BUCKET }}/prod/ 2>/dev/null | wc -l)

          echo "latest_backup=$LATEST_BACKUP" >> $GITHUB_OUTPUT
          echo "b2_count=$B2_COUNT" >> $GITHUB_OUTPUT

          echo "Latest from Google Drive: $LATEST_BACKUP"
          echo "Total backups in B2: $B2_COUNT"

          # List a few recent B2 backups
          echo ""
          echo "=== Recent B2 Backups ==="
          rclone lsf b2:${{ env.B2_BUCKET }}/prod/ --max-depth 1 | sort -r | head -5

          # Calculate approximate storage size
          B2_SIZE=$(rclone size b2:${{ env.B2_BUCKET }}/prod/ --json | python3 -c "import sys, json; print(json.load(sys.stdin)['bytes'])")
          B2_SIZE_MB=$((B2_SIZE / 1024 / 1024))
          echo ""
          echo "B2 Storage Used: ~${B2_SIZE_MB} MB"

          if [ $B2_SIZE_MB -gt 1000 ]; then
            echo "::warning::B2 storage is over 1GB (${B2_SIZE_MB} MB). Consider checking retention policy."
          fi

      - name: Send notification on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue_body = `## Backup Copy to B2 Failed

            The scheduled backup copy from Google Drive to Backblaze B2 has failed.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Time:** ${new Date().toISOString()}

            Please investigate the workflow logs and ensure:
            - Google Drive credentials (RCLONE_CONFIG_CONTENT) are valid
            - Backblaze B2 credentials (B2_APPLICATION_KEY_ID, B2_APPLICATION_KEY) are valid
            - B2_BUCKET_NAME secret is set correctly
            - Network connectivity is working
            - Storage quota is not exceeded

            This is an automated notification.`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Backup Copy to B2 Failed',
              body: issue_body,
              labels: ['backup', 'alert', 'infrastructure']
            });

      - name: Generate summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # Backup Copy to B2 Summary

          ## Status

          | Action | Status |
          |--------|--------|
          | Copy latest backup to B2 | ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }} |

          ## Details

          | Item | Value |
          |------|-------|
          | Latest backup copied | \`${{ steps.verify.outputs.latest_backup }}\` |
          | B2 backups (before retention) | ${{ steps.list_b2_before.outputs.b2_count_before }} |
          | B2 backups (after retention) | ${{ steps.verify.outputs.b2_count }} |

          **Completed:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ---

          ### How It Works
          - Copies ONLY the latest backup from Google Drive to B2 each day
          - Applies retention policy to B2 independently (7 daily, 4 weekly, 12 monthly, yearly forever)
          - Even if Google Drive is wiped, B2 keeps all existing backups
          - Target: ~30 backups, ~1GB storage (under 10GB free tier)
          EOF
