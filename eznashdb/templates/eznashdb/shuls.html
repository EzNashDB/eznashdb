{% extends "base.html" %}

{% load static %}
{% load partials %}

{% block main_scroll_container_classes %}
    shuls-scroll-container
{% endblock main_scroll_container_classes %}

{% block container_classes %}
    h-100
{% endblock container_classes %}

{% block extra_media_top %}
    <link rel="stylesheet" href="{% static 'eznashdb/css/shuls.css' %}">
{% endblock extra_media_top %}

{% block content %}
    <div class="row h-100 d-flex flex-column flex-lg-row">
        <!-- Filter sidebar: top on mobile, left on desktop -->
        <div class="col-12 col-lg-4 col-xl-3  d-lg-flex flex-column overflow-auto h-lg-100 max-h-50"
            {# djlint:off #}
         x-data="{
             filtersCollapsed: localStorage.getItem('shulFiltersCollapsed') === 'true',
             filterCount: 0,
             toggleFilters() {
                 this.filtersCollapsed = !this.filtersCollapsed;
                 localStorage.setItem('shulFiltersCollapsed', this.filtersCollapsed)
                 const filterContainer = document.getElementById('filter-container');
                 const bsCollapse = bootstrap.Collapse.getInstance(filterContainer) || new bootstrap.Collapse(filterContainer, { toggle: false });
                 this.filtersCollapsed ? bsCollapse.hide() : bsCollapse.show();
             }
         }"
            @filter-count-changed.window="filterCount = $event.detail"
            {# djlint:on #}
            >
            <div class="d-flex justify-content-between gap-2 mb-3">
                <!-- Filter toggle button (small screens only) -->
                <div class="btn-group">
                    <button id="filter-toggle-btn"
                            @click="toggleFilters()"
                            class="btn btn-secondary d-lg-none">
                        <span>Filters (<span x-text="filterCount">0</span>)</span>
                        <i class="fa"
                           :class="filtersCollapsed ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                    </button>
                    <button @click="FILTER_API.reset()"
                            class="btn btn-outline-secondary rounded-lg"
                            :disabled="filterCount === 0">
                        <i class="fa-solid fa-rotate-left"></i>
                        Reset
                    </button>
                </div>
                <!-- Add Shul button -->
                <a href="{% url 'eznashdb:create_shul' %}" class="btn btn-primary">
                    <i class="fa fa-plus"></i> Add Shul
                </a>
            </div>
            <!-- Filters (collapsible on mobile, always visible on desktop) -->
            <div class="collapse d-lg-block"
                id="filter-container"
                {# djlint:off #}
                x-init="() => {
                    const isSmallScreen = window.innerWidth < 1024;
                    if (isSmallScreen && !filtersCollapsed) {
                        $el.classList.add('show');
                    }
                }"
                {# djlint:on #}
                >{% include "eznashdb/includes/shul_filters.html" %}</div>
        </div>
        <!-- Map column: below filters on mobile, right side on desktop -->
        <div class="col-12 col-lg-8 col-xl-9 d-flex flex-column flex-grow-1">
            <div class="flex-grow-1 w-100">
                <div class="border rounded h-100 position-relative map-container">
                    <span class="spinner-overlay bg-secondary w-100 h-100 rounded text-center d-flex align-items-center opacity-0">
                        <div class="flex-grow-1 text-center">
                            <span class="spinner-border spinner-border-lg"
                                  style="width: 3rem;
                                         height: 3rem"
                                  role="status">
                                <span class="visually-hidden">Loading...</span>
                            </span>
                        </div>
                    </span>
                    <div id="shuls-map" class="h-100">
                        <div class="w-100 p-2 position-absolute top-0 start-50"
                             style="transform: translateX(-50%);
                                    z-index: 1000;
                                    pointer-events: none">
                            <div class="fs-5 opacity-75 d-flex flex-wrap justify-content-between gap-1">
                                <div class="badge text-bg-warning text-wrap" style="pointer-events: auto">
                                    <i class="fa-solid fa-lock"></i>
                                    Map pins are approximate. Exact locations hidden for security reasons.
                                </div>
                                <div class="badge text-bg-dark" style="pointer-events: auto">
                                    {% include "eznashdb/includes/shuls_count.html" %}
                                </div>
                            </div>
                        </div>
                        <div class="position-absolute bottom-0 start-0 p-2 d-flex flex-column gap-2"
                             style="z-index: 1000;
                                    pointer-events: none">
                            <div style="pointer-events: auto" class="align-self-end">
                                <button id="locate-me-btn" class="btn btn-light shadow-sm">
                                    <i class="fa-solid fa-location-crosshairs"></i>
                                </button>
                            </div>
                            <div class="btn-group-vertical shadow-sm w-fit-content"
                                 style="pointer-events: auto">
                                <button id="zoom-in-btn" class="btn btn-light border">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                                <button id="zoom-out-btn" class="btn btn-light border">
                                    <i class="fa-solid fa-minus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="offcanvas offcanvas-bottom shuls-offcanvas p-0 rounded-top h-auto"
             tabindex="-1"
             id="shulOffcanvas"
             aria-labelledby="shulOffcanvasLabel">
            <div class="offcanvas-body p-0"></div>
        </div>
    </div>
{% endblock %}

{% block extra_media_bottom %}
    {{ block.super }}
    <script defer>
        (() => {
            // ============================================================================
            // URL PARAMS API
            // ============================================================================

            window.URL_PARAMS_API = (() => {
                const updateURLParams = (params) => {
                    const url = new URL(window.location.href);
                    for (const key in params) url.searchParams.set(key, params[key]);
                    history.replaceState({}, "", url.toString());
                };

                const deleteURLParams = (params) => {
                    const url = new URL(window.location.href);
                    params.forEach((param) => url.searchParams.delete(param));
                    history.replaceState({}, "", url.toString());
                };

                const getURLParam = (param) => {
                    const params = new URLSearchParams(window.location.search);
                    return params.get(param)
                }

                return {
                    update: updateURLParams,
                    delete: deleteURLParams,
                    get: getURLParam,
                };
            })();

            // ============================================================================
            // FILTER MANAGEMENT
            // ============================================================================

            window.FILTER_API = (() => {
                const getForm = () => document.querySelector('#filter-container form');

                const updateCount = () => {
                    const form = getForm();
                    if (!form) return;

                    let count = 0;
                    form.querySelectorAll('select, input[type="text"], input[type="number"]').forEach(input => {
                        if (input.value && input.value.trim() !== '') {
                            count++;
                        }
                    });

                    window.dispatchEvent(new CustomEvent('filter-count-changed', { detail: count }));
                };

                const init = () => {
                    const form = getForm();
                    if (form) {
                        form.addEventListener('change', updateCount);
                        form.addEventListener('input', updateCount);
                    }
                    updateCount();
                };

                const reset = () => {
                    const form = getForm();
                    if (!form) return;
                    form.querySelectorAll('select.tom-select').forEach(select => {
                        if (select.tomselect) select.tomselect.clear();
                    });
                    form.querySelectorAll('input').forEach(input => input.value = '');
                    updateCount();
                    htmx.ajax('GET', form.getAttribute('hx-get'), {swap: 'none'});
                };

                return { init, updateCount, reset };
            })();

            // ============================================================================
            // UTILITY FUNCTIONS
            // ============================================================================

            const updateURLLocationParams = (map) => {
                const center = map.getCenter();
                URL_PARAMS_API.update({
                    lat: center.lat,
                    lon: center.lng,
                    zoom: map.getZoom(),
                });
            };

            const isSmallScreen = () => {
                return window.innerWidth < 1024 || window.innerHeight < 600;
            };

            const getClusterKey = (lat, lon) => {
                return `${lat}_${lon}`;
            };

            // ============================================================================
            // POPUP SETUP HELPER
            // ============================================================================
            let lastOpenedClusterKey = null;

            function setupClusterPopup(targetElement, clusterKey, popupContent) {

                if (isSmallScreen()) {
                    URL_PARAMS_API.update({ selectedCluster: clusterKey });
                    // Small screen - use offcanvas
                    const offcanvasEl = document.getElementById("shulOffcanvas");
                    offcanvasEl.querySelector(".offcanvas-body").innerHTML = popupContent;

                    const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
                    offcanvasEl.addEventListener('hidden.bs.offcanvas', () => {
                        URL_PARAMS_API.delete(["selectedCluster", "selectedShul"]);
                    }, { once: true });
                    bsOffcanvas.show();

                    const closeBtn = offcanvasEl.querySelector(".shul-popup-close");
                    if (closeBtn) {
                        closeBtn.addEventListener("click", (ev) => {
                            ev.preventDefault();
                            bsOffcanvas.hide();
                        });
                    }
                } else {
                    lastOpenedClusterKey = clusterKey;
                    // Large screen - use popup
                    targetElement.bindPopup(popupContent, {
                        className: "shul-cluster-popup",
                        closeButton: false,
                        offset: [0, -7],
                    }).openPopup();

                    setTimeout(() => {
                        const popupEl = targetElement.getPopup().getElement();
                        if (!popupEl) return;

                        const closeBtn = popupEl.querySelector(".shul-popup-close");
                        if (closeBtn) {
                            closeBtn.addEventListener("click", (ev) => {
                                ev.preventDefault();
                                targetElement.closePopup();
                            });
                        }
                    }, 0);
                }
            }



            // ============================================================================
            // MAP INITIALIZATION
            // ============================================================================

            const initMap = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const mapId = "shuls-map";
                const startLat = parseFloat(urlParams.get("lat")) || 20;
                const startLon = parseFloat(urlParams.get("lon")) || 10;
                const startZoom = parseInt(urlParams.get("zoom"), 10) || 2;

                // Create map
                const map = L.map(mapId, {
                    center: [startLat, startLon],
                    zoom: startZoom,
                    scrollWheelZoom: true,
                    worldCopyJump: true,
                    minZoom: 1,
                    maxZoom: 15,
                    zoomControl: false,
                });

                // Add tile layer
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?", {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                }).addTo(map);
                document.getElementById(mapId).classList.add("rounded");

                // Custom zoom controls
                const zoomInBtn = document.getElementById("zoom-in-btn");
                const zoomOutBtn = document.getElementById("zoom-out-btn");

                const updateZoomButtons = () => {
                    const zoom = map.getZoom();
                    if (zoomInBtn) zoomInBtn.disabled = zoom >= map.getMaxZoom();
                    if (zoomOutBtn) zoomOutBtn.disabled = zoom <= map.getMinZoom();
                };

                if (zoomInBtn) {
                    L.DomEvent.disableClickPropagation(zoomInBtn);
                    zoomInBtn.addEventListener("click", () => map.zoomIn());
                }
                if (zoomOutBtn) {
                    L.DomEvent.disableClickPropagation(zoomOutBtn);
                    zoomOutBtn.addEventListener("click", () => map.zoomOut());
                }

                map.on("zoomend", updateZoomButtons);
                updateZoomButtons();

                // Locate Me button
                let locationCircle = null;
                let locationMarker = null;
                const locateMeBtn = document.getElementById("locate-me-btn");

                const clearLocationCircle = () => {
                    if (locationCircle) {
                        map.removeLayer(locationCircle);
                        locationCircle = null;
                    }
                    if (locationMarker) {
                        map.removeLayer(locationMarker);
                        locationMarker = null;
                    }
                };

                const LOCATION_MARKER_MIN_ZOOM = 13;

                const createCloseIcon = () => {
                    return L.divIcon({
                        html: `
                        <div class="d-flex flex-column align-items-center opacity-75">
                            <div class="btn btn-info rounded-circle shadow-sm d-flex align-items-center justify-content-center" style="width:40px; height:40px;">
                                <i class="fa-solid fa-xmark"></i>
                            </div>
                            <h6><span class="badge text-bg-dark">Your Location</span></h6>
                        </div>
                        `,
                        className: '',
                        iconSize: [40, 40],
                        iconAnchor: [20, 20],
                    });
                };

                const updateLocationMarkerVisibility = () => {
                    if (!locationMarker) return;
                    const markerEl = locationMarker.getElement();
                    if (!markerEl) return;
                    markerEl.style.display = map.getZoom() >= LOCATION_MARKER_MIN_ZOOM ? '' : 'none';
                };

                if (locateMeBtn) {
                    // Prevent map drag when interacting with button
                    L.DomEvent.disableClickPropagation(locateMeBtn);

                    locateMeBtn.addEventListener("click", () => {
                        window.GeolocationUtils.getCurrentPosition({
                            onSuccess: ({ latitude, longitude }) => {
                                map.setView([latitude, longitude], 16);
                                clearLocationCircle();
                                locationMarker = L.marker([latitude, longitude], { icon: createCloseIcon() }).addTo(map);
                                locationMarker.on("click", clearLocationCircle);
                                updateLocationMarkerVisibility();
                            },
                        });
                    });

                    map.on("zoomend", updateLocationMarkerVisibility);
                }

                // small delay allows CSS/layout to finish
                map.whenReady(() => {
                    setTimeout(() => map.invalidateSize(), 150);
                });

                // Keep URL in sync with map movements
                map.on("moveend", () => updateURLLocationParams(map));
                map.on("zoomend", () => updateURLLocationParams(map));
                map.on("popupopen", (e) => {
                    if (lastOpenedClusterKey) {
                        URL_PARAMS_API.update({ selectedCluster: lastOpenedClusterKey })
                    }
                });
                map.on("popupclose", (e) => {
                    URL_PARAMS_API.delete(["selectedCluster", "selectedShul"])

                    const source = e.popup && e.popup._source;
                    if (source && typeof source.unbindPopup === "function") {
                        source.unbindPopup();
                    }
                });

                // Create marker cluster group
                const markersLayer = L.markerClusterGroup({
                    showCoverageOnHover: false,
                    spiderfyOnMaxZoom: false,
                    zoomToBoundsOnClick: false,
                    spiderfyDistanceMultiplier: 0,
                    disableClusteringAtZoom: null
                });

                markersLayer.on('spiderfied', (e) => {
                    // Don't spiderfy - clustered shuls should stay together
                    e.preventDefault();
                    return false;
                });

                map.addLayer(markersLayer);

                // ============================================================================
                // CLUSTER AND MARKER CLICK HANDLERS
                // ============================================================================

                markersLayer.on('clusterclick', (cluster) => {
                    L.DomEvent.stop(cluster.originalEvent);
                    const childMarkers = cluster.layer.getAllChildMarkers();
                    const firstPos = childMarkers[0].getLatLng();

                    // Check if all markers are at the same location (security cluster)
                    const allSamePosition = childMarkers.every(m => {
                        const pos = m.getLatLng();
                        return Math.abs(pos.lat - firstPos.lat) < 0.0001 &&
                               Math.abs(pos.lng - firstPos.lng) < 0.0001;
                    });

                    if (!allSamePosition) {
                        // Regular geographic cluster - zoom in
                        cluster.layer.zoomToBounds({ padding: [20, 20] });
                        return;
                    }

                    // Security cluster - show combined popup
                    const clusterKey = getClusterKey(firstPos.lat, firstPos.lng);
                    const popupContent = window.SHUL_MAP_API.clusterPopupHtmlMap?.[clusterKey];

                    if (!popupContent) {
                        console.error('No cluster popup found for cluster key:', clusterKey);
                        return;
                    }

                    setupClusterPopup(cluster.layer, clusterKey, popupContent);
                });

                // Handle single marker clicks
                markersLayer.on('click', (e) => {
                    const marker = e.layer;
                    const shulId = marker.options.shulId;
                    if (!shulId) return;

                    const clusterKey = window.SHUL_MAP_API.shulToClusterKey[shulId];
                    const popupContent = window.SHUL_MAP_API.clusterPopupHtmlMap?.[clusterKey];

                    if (!popupContent) {
                        console.error('No popup found for cluster key:', clusterKey);
                        return;
                    }

                    setupClusterPopup(marker, clusterKey, popupContent);
                });

                // ============================================================================
                // MARKER HANDLING
                // ============================================================================

                const markersByPopupId = {};

                function singleClusterIcon() {
                    return L.divIcon({
                        html: `<div class="marker-cluster marker-cluster-single"><span>1</span></div>`,
                        className: 'marker-cluster-wrapper',
                        iconSize: [38, 38],
                    });
                }

                const addMarker = (shulId, lat, lon, popupId, icon = null) => {
                    const marker = L.marker([lat, lon], { icon: icon || singleClusterIcon() });
                    marker.options.shulId = shulId;
                    marker.options.popupId = popupId;
                    markersLayer.addLayer(marker);
                    markersByPopupId[String(popupId)] = marker;
                    return marker;
                };

                const addMarkerWithWorldWrap = (shulId, lat, lon, icon = null) => {
                    addMarker(shulId, lat, lon, String(shulId), icon);
                    addMarker(shulId, lat, lon - 360, "-" + String(shulId), icon);
                    addMarker(shulId, lat, lon + 360, "+" + String(shulId), icon);
                };

                const clearMarkers = () => {
                    markersLayer.clearLayers();
                    for (const k in markersByPopupId) delete markersByPopupId[k];
                };

                // ============================================================================
                // AUTO OPEN MARKER
                // ============================================================================

                const autoOpenMarker = () => {
                    const api = window.SHUL_MAP_API;

                    // Check for justSaved first (highest priority - newly saved shul)
                    const justSavedId = '{{exact_pin_shul.id}}';
                    if (justSavedId) {
                        const exactPinMarker = api.markersByPopupId[justSavedId];
                        if (exactPinMarker) {
                            api.markersLayer.fire('click', { layer: exactPinMarker });
                            return;
                        }
                    }

                    // Otherwise handle selectedShul/selectedCluster from URL params
                    const selectedShulId = urlParams.get("selectedShul");
                    const selectedCluster = urlParams.get("selectedCluster");

                    if (selectedShulId) {
                        const clusterKey = api.shulToClusterKey[selectedShulId];
                        if (!clusterKey) return;

                        const target = api.markersByPopupId[String(selectedShulId)];
                        if (!target) return;

                        const cluster = api.markersLayer.getVisibleParent(target);

                        if (cluster && cluster instanceof L.MarkerCluster) {
                            // Click cluster and expand specific accordion
                            cluster._icon?.click();

                            setTimeout(() => {
                                const accordionItem = document.querySelector(`#shul-${selectedShulId}`);
                                if (accordionItem && !accordionItem.classList.contains('show')) {
                                    new bootstrap.Collapse(accordionItem, { toggle: true });
                                }
                            }, 200);
                        } else {
                            // Single marker
                            api.markersLayer.fire('click', { layer: target });
                        }
                    } else if (selectedCluster) {
                        // Open cluster without expanding any accordion
                        const shulIdInCluster = Object.keys(api.shulToClusterKey).find(
                            id => api.shulToClusterKey[id] === selectedCluster
                        );

                        if (shulIdInCluster) {
                            const target = api.markersByPopupId[String(shulIdInCluster)];
                            if (target) {
                                const cluster = api.markersLayer.getVisibleParent(target);
                                if (cluster && cluster instanceof L.MarkerCluster) {
                                    cluster._icon?.click();
                                } else {
                                    api.markersLayer.fire('click', { layer: target });
                                }
                            }
                        }
                    }
                };

            function initShulAccordion(item, shulId) {
                const collapseEl = item.querySelector('.accordion-collapse');

                collapseEl.addEventListener('show.bs.collapse', () => {
                    URL_PARAMS_API.update({ 'selectedShul': shulId });
                });

                collapseEl.addEventListener('shown.bs.collapse', () => {
                    if (window.SHUL_MAP_API?.map) {
                        setTimeout(() => {
                            const openPopup = window.SHUL_MAP_API.map._popup;
                            if (openPopup && openPopup._adjustPan) openPopup._adjustPan();
                        }, 100);
                    }

                    // Scroll within the popup container only
                    const header = item.querySelector('.accordion-header');
                    scrollIntoViewWithinContainer(header, {
                        behavior: 'smooth',
                        block: 'start',
                        offset: 15
                    });
                });

                collapseEl.addEventListener('hide.bs.collapse', () => {
                    const isClosingActiveRoom = URL_PARAMS_API.get('selectedShul') === String(shulId);
                    if (isClosingActiveRoom) URL_PARAMS_API.delete(['selectedShul']);
                });
            }

                // ============================================================================
                // EXPOSE API
                // ============================================================================

                window.SHUL_MAP_API = {
                    ...(window.SHUL_MAP_API || {}),
                    map,
                    markersLayer,
                    markersByPopupId,
                    addMarker,
                    addMarkerWithWorldWrap,
                    clearMarkers,
                    autoOpenMarker,
                    initShulAccordion,
                };
            };

            // Initialize map and filter count when DOM is ready
            document.addEventListener("DOMContentLoaded", () => {
                initMap();
                FILTER_API.init();
            });
        })();
    </script>
    {% partialdef map_updates inline=True %}
    <div class="d-none">{% include "eznashdb/includes/shuls_count.html" %}</div>
    <script id="shul-markers-js" hx-swap-oob="true" defer>
        (() => {
            document.dispatchEvent(new Event("shulsDataLoaded"));

            // ============================================================================
            // ADD SHUL MARKERS TO MAP
            // ============================================================================

            const addShulMarkers = () => {
                const mapApi = window.SHUL_MAP_API;
                const shulToClusterKey = {};

                // Store cluster offset info
                {% if cluster_offset %}
                    const clusterOffset = {
                        clusterKey: "{{ cluster_offset.cluster_key }}",
                        offsetLon: {{ cluster_offset.offset_lon }}
                    };
                {% else %}
                    const clusterOffset = null;
                {% endif %}

                // Add individual shul markers
                {% for shul in clustered_shuls_list %}
                    const clusterKey_{{ shul.id }} = "{{ shul.display_lat }}_{{ shul.display_lon }}";
                    shulToClusterKey["{{ shul.id }}"] = clusterKey_{{ shul.id }};

                    (() => {
                        const id = {{ shul.id }};
                        let lat = parseFloat({{ shul.display_lat }});
                        let lon = parseFloat({{ shul.display_lon }});
                        // Apply cluster offset if applicable (horizontal only)
                        if (clusterOffset && clusterKey_{{ shul.id }} === clusterOffset.clusterKey) {
                            lon += clusterOffset.offsetLon;
                        }
                        mapApi.addMarkerWithWorldWrap(id, lat, lon);
                    })();
                {% endfor %}

                // Build cluster popups for ALL shuls (including singles)
                const clusterPopupHtmlMap = {};
                {% for cluster_key, shuls in shul_clusters.items %}
                    clusterPopupHtmlMap["{{ cluster_key }}"] = `{% include "eznashdb/includes/shul_cluster_popup.html" with shuls=shuls %}`;
                {% endfor %}

                // Add exact pin if present (blue icon at exact coordinates, not jittered)
                {% if exact_pin_shul %}
                    const exactPinIcon = L.icon({
                        iconUrl: '{% static "eznashdb/images/marker-icon.png" %}',
                        shadowUrl: '{% static "eznashdb/images/marker-shadow.png" %}',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -27],
                        shadowSize: [41, 41]
                    });
                    const exactPinClusterKey = `exact_pin_{{ exact_pin_shul.id }}`;
                    clusterPopupHtmlMap[exactPinClusterKey] = `{% include "eznashdb/includes/exact_pin_popup.html" with shul=exact_pin_shul %}`;
                    shulToClusterKey[{{ exact_pin_shul.id }}] = exactPinClusterKey;
                    mapApi.addMarkerWithWorldWrap(
                        {{ exact_pin_shul.id }},
                        {{ exact_pin_shul.latitude }},
                        {{ exact_pin_shul.longitude }},
                        exactPinIcon
                    );
                {% endif %}

                mapApi.clusterPopupHtmlMap = clusterPopupHtmlMap;
                mapApi.shulToClusterKey = shulToClusterKey;
            };

            // ============================================================================
            // REPLACE MAP SHULS (CALLED ON FILTER CHANGE)
            // ============================================================================

            const replaceMapShuls = () => {
                const mapApi = window.SHUL_MAP_API;
                mapApi.clearMarkers();
                addShulMarkers();
                mapApi.autoOpenMarker();
            };

            // ============================================================================
            // EXPOSE API AND INITIALIZE
            // ============================================================================

            window.SHUL_MAP_API = {
                ...window.SHUL_MAP_API,
                addShulMarkers,
                replaceMapShuls,
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    window.SHUL_MAP_API.replaceMapShuls();
                });
            } else {
                window.SHUL_MAP_API.replaceMapShuls();
            }
        })();
    </script>
{% endpartialdef map_updates %}
<script defer src="{% static 'eznashdb/js/map_spinner.js' %}"></script>
{% endblock extra_media_bottom %}
