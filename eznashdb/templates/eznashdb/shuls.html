{% extends "base_full_height.html" %}

{% load static %}
{% load partials %}

{% block extra_media_top %}
    <link rel="stylesheet" href="{% static 'eznashdb/css/shuls.css' %}">
{% endblock extra_media_top %}

{% block content %}
    <div class="row h-100">
        <div class="col h-100 d-flex flex-column">
            <div class="row mb-1">
                <!-- Filter toggle button (small screens only) -->
                <div class="col-6 d-md-none">
                    <button id="filter-toggle-btn"
                            class="btn btn-outline-secondary w-100 d-flex align-items-center">
                        <span class="flex-grow-1">Filters (<span id="filter-count">0</span>)</span>
                        <i class="fa fa-chevron-up" id="filter-chevron"></i>
                    </button>
                </div>
                <!-- Add Shul button (always on the right) -->
                <div class="col-6 col-md-auto ms-md-auto mt-auto mb-3">
                    <a href="{% url 'eznashdb:create_shul' %}" class="btn btn-primary w-100">
                        <i class="fa fa-plus"></i> Add a Shul
                    </a>
                </div>
                <!-- Filters (wraps to new line on small, inline on large) -->
                <div class="col-12 col-md order-md-first collapse d-md-block"
                     id="filter-container">{% include "eznashdb/includes/shul_filters.html" %}</div>
            </div>
            <div class="row flex-grow-1">
                <div class="col-12">
                    <div class="border rounded h-100 position-relative">
                        <span class="spinner-overlay bg-secondary w-100 h-100 rounded text-center d-flex align-items-center opacity-0">
                            <div class="flex-grow-1 text-center">
                                <span class="spinner-border spinner-border-lg"
                                      style="width: 3rem;
                                             height: 3rem"
                                      role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </span>
                            </div>
                        </span>
                        <div id="shuls-map" class="h-100">
                            <div class="w-100 p-2 position-absolute top-0 start-50"
                                 style="transform: translateX(-50%);
                                        z-index: 1000;
                                        pointer-events: none">
                                <div class="fs-5 opacity-75 d-flex flex-wrap justify-content-between gap-1">
                                    <div class="badge text-bg-warning text-wrap" style="pointer-events: auto">
                                        <i class="fa-solid fa-lock"></i>
                                        Map pins are approximate. Exact locations hidden for security reasons.
                                    </div>
                                    <div class="badge text-bg-dark" style="pointer-events: auto">
                                        {% include "eznashdb/includes/shuls_count.html" %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="offcanvas offcanvas-bottom p-0 rounded-top h-auto"
             tabindex="-1"
             id="shulOffcanvas"
             aria-labelledby="shulOffcanvasLabel">
            <div class="offcanvas-body p-0"></div>
        </div>
    </div>
{% endblock %}

{% block extra_media_bottom %}
    {{ block.super }}
    <script defer>
        (() => {
            // ============================================================================
            // URL PARAMS API
            // ============================================================================

            window.URL_PARAMS_API = (() => {
                const updateURLParams = (params) => {
                    const url = new URL(window.location.href);
                    for (const key in params) url.searchParams.set(key, params[key]);
                    history.replaceState({}, "", url.toString());
                };

                const deleteURLParams = (params) => {
                    const url = new URL(window.location.href);
                    params.forEach((param) => url.searchParams.delete(param));
                    history.replaceState({}, "", url.toString());
                };

                const getURLParam = (param) => {
                    const params = new URLSearchParams(window.location.search);
                    return params.get(param)
                }

                return {
                    update: updateURLParams,
                    delete: deleteURLParams,
                    get: getURLParam,
                };
            })();

            // ============================================================================
            // FILTER TOGGLE MANAGEMENT
            // ============================================================================

            window.FILTER_TOGGLE_API = (() => {
                const BREAKPOINT_MD = 768; // Bootstrap md breakpoint

                const isSmallScreen = () => window.innerWidth < BREAKPOINT_MD;

                const updateFilterCount = () => {
                    const form = document.querySelector('#filter-container form');
                    const countSpan = document.getElementById('filter-count');
                    if (!form || !countSpan) return;

                    let count = 0;
                    const inputs = form.querySelectorAll('select, input[type="text"], input[type="number"]');
                    inputs.forEach(input => {
                        if (input.value && input.value.trim() !== '') {
                            count++;
                        }
                    });

                    countSpan.textContent = count;
                };

                const initFilterToggle = () => {
                    const filterContainer = document.getElementById('filter-container');
                    const toggleBtn = document.getElementById('filter-toggle-btn');
                    const chevronIcon = document.getElementById('filter-chevron');

                    if (!filterContainer || !toggleBtn) return;

                    const bsCollapse = new bootstrap.Collapse(filterContainer, { toggle: false });

                    // Toggle chevron icon on collapse events
                    filterContainer.addEventListener('show.bs.collapse', () => {
                        if (chevronIcon) {
                            chevronIcon.classList.remove('fa-chevron-down');
                            chevronIcon.classList.add('fa-chevron-up');
                        }
                    });

                    filterContainer.addEventListener('hide.bs.collapse', () => {
                        if (chevronIcon) {
                            chevronIcon.classList.remove('fa-chevron-up');
                            chevronIcon.classList.add('fa-chevron-down');
                        }
                    });

                    // Handle button click
                    toggleBtn.addEventListener('click', () => {
                        if (!isSmallScreen()) return; // Safety check

                        const isExpanded = filterContainer.classList.contains('show');

                        if (isExpanded) {
                            bsCollapse.hide();
                            URL_PARAMS_API.update({ filters: 'hide' });
                        } else {
                            bsCollapse.show();
                            URL_PARAMS_API.delete(['filters']);
                        }
                    });

                    // Handle resize - manage state transitions
                    const handleResize = () => {
                        if (isSmallScreen()) {
                            // Small screen - respect collapse state (managed by Bootstrap)
                            // Button is visible via CSS (d-md-none)
                        } else {
                            // Large screen - always show filters and clean up URL param
                            if (!filterContainer.classList.contains('show')) {
                                filterContainer.classList.add('show');
                            }
                            URL_PARAMS_API.delete(['filters']);
                        }
                    };

                    let resizeTimeout;
                    window.addEventListener('resize', () => {
                        clearTimeout(resizeTimeout);
                        resizeTimeout = setTimeout(handleResize, 100);
                    });

                    // Initial state on page load
                    if (isSmallScreen()) {
                        const filterParam = URL_PARAMS_API.get('filters');
                        if (filterParam === 'hide') {
                            // User explicitly hid filters - keep them hidden
                            // Collapse already has 'collapse' class, so it's hidden by default
                        } else {
                            // Default to shown on small screen
                            bsCollapse.show();
                        }
                    } else {
                        // Large screen - always show (d-md-block handles this via CSS)
                        filterContainer.classList.add('show');
                    }

                    // Update count on filter change
                    const form = filterContainer.querySelector('form');
                    if (form) {
                        form.addEventListener('change', updateFilterCount);
                        form.addEventListener('input', updateFilterCount);
                    }

                    // Initial count
                    updateFilterCount();
                };

                return {
                    init: initFilterToggle,
                    updateCount: updateFilterCount,
                };
            })();

            // ============================================================================
            // UTILITY FUNCTIONS
            // ============================================================================

            const updateURLLocationParams = (map) => {
                const center = map.getCenter();
                URL_PARAMS_API.update({
                    lat: center.lat,
                    lon: center.lng,
                    zoom: map.getZoom(),
                });
            };

            const isSmallScreen = () => {
                return window.innerWidth < 768 || window.innerHeight < 600;
            };

            const getClusterKey = (lat, lon) => {
                return `${lat}_${lon}`;
            };

            // ============================================================================
            // POPUP SETUP HELPER
            // ============================================================================
            let lastOpenedClusterKey = null;

            function setupClusterPopup(targetElement, clusterKey, popupContent) {

                if (isSmallScreen()) {
                    URL_PARAMS_API.update({ selectedCluster: clusterKey });
                    // Small screen - use offcanvas
                    const offcanvasEl = document.getElementById("shulOffcanvas");
                    offcanvasEl.querySelector(".offcanvas-body").innerHTML = popupContent;

                    const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
                    offcanvasEl.addEventListener('hidden.bs.offcanvas', () => {
                        URL_PARAMS_API.delete(["selectedCluster", "selectedShul"]);
                    }, { once: true });
                    bsOffcanvas.show();

                    const closeBtn = offcanvasEl.querySelector(".shul-popup-close");
                    if (closeBtn) {
                        closeBtn.addEventListener("click", (ev) => {
                            ev.preventDefault();
                            bsOffcanvas.hide();
                        });
                    }
                } else {
                    lastOpenedClusterKey = clusterKey;
                    // Large screen - use popup
                    targetElement.bindPopup(popupContent, {
                        className: "shul-cluster-popup",
                        closeButton: false,
                        offset: [0, -7],
                    }).openPopup();

                    setTimeout(() => {
                        const popupEl = targetElement.getPopup().getElement();
                        if (!popupEl) return;

                        const closeBtn = popupEl.querySelector(".shul-popup-close");
                        if (closeBtn) {
                            closeBtn.addEventListener("click", (ev) => {
                                ev.preventDefault();
                                targetElement.closePopup();
                            });
                        }
                    }, 0);
                }
            }



            // ============================================================================
            // MAP INITIALIZATION
            // ============================================================================

            const initMap = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const mapId = "shuls-map";
                const startLat = parseFloat(urlParams.get("lat")) || 20;
                const startLon = parseFloat(urlParams.get("lon")) || 10;
                const startZoom = parseInt(urlParams.get("zoom"), 10) || 2;

                // Create map
                const map = L.map(mapId, {
                    center: [startLat, startLon],
                    zoom: startZoom,
                    scrollWheelZoom: true,
                    worldCopyJump: true,
                    minZoom: 1,
                    zoomControl: false,
                });

                // Add tile layer and controls
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?", {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                }).addTo(map);
                L.control.zoom({ position: "bottomleft" }).addTo(map);
                document.getElementById(mapId).classList.add("rounded");

                // small delay allows CSS/layout to finish
                map.whenReady(() => {
                    setTimeout(() => map.invalidateSize(), 150);
                });

                // Keep URL in sync with map movements
                map.on("moveend", () => updateURLLocationParams(map));
                map.on("zoomend", () => updateURLLocationParams(map));
                map.on("popupopen", (e) => {
                    if (lastOpenedClusterKey) {
                        URL_PARAMS_API.update({ selectedCluster: lastOpenedClusterKey })
                    }
                });
                map.on("popupclose", (e) => {
                    URL_PARAMS_API.delete(["selectedCluster", "selectedShul"])

                    const source = e.popup && e.popup._source;
                    if (source && typeof source.unbindPopup === "function") {
                        source.unbindPopup();
                    }
                });

                // Create marker cluster group
                const markersLayer = L.markerClusterGroup({
                    showCoverageOnHover: false,
                    spiderfyOnMaxZoom: false,
                    zoomToBoundsOnClick: false,
                    spiderfyDistanceMultiplier: 0,
                    disableClusteringAtZoom: null
                });

                markersLayer.on('spiderfied', (e) => {
                    // Don't spiderfy - clustered shuls should stay together
                    e.preventDefault();
                    return false;
                });

                map.addLayer(markersLayer);

                // Track exact pin marker (always in markersLayer for natural clustering)
                let exactPinMarker = null;

                // ============================================================================
                // CLUSTER AND MARKER CLICK HANDLERS
                // ============================================================================

                markersLayer.on('clusterclick', (cluster) => {
                    L.DomEvent.stop(cluster.originalEvent);
                    const childMarkers = cluster.layer.getAllChildMarkers();
                    const firstPos = childMarkers[0].getLatLng();

                    // Check if all markers are at the same location (security cluster)
                    const allSamePosition = childMarkers.every(m => {
                        const pos = m.getLatLng();
                        return Math.abs(pos.lat - firstPos.lat) < 0.0001 &&
                               Math.abs(pos.lng - firstPos.lng) < 0.0001;
                    });

                    if (!allSamePosition) {
                        // Regular geographic cluster - zoom in
                        cluster.layer.zoomToBounds({ padding: [20, 20] });
                        return;
                    }

                    // Security cluster - show combined popup
                    const clusterKey = getClusterKey(firstPos.lat, firstPos.lng);
                    const popupContent = window.SHUL_MAP_API.clusterPopupHtmlMap?.[clusterKey];

                    if (!popupContent) {
                        console.error('No cluster popup found for cluster key:', clusterKey);
                        return;
                    }

                    setupClusterPopup(cluster.layer, clusterKey, popupContent);
                });

                // Handle single marker clicks
                markersLayer.on('click', (e) => {
                    const marker = e.layer;

                    // Exact pin clicks are handled by individual marker click handler
                    // Skip them here to avoid double-firing
                    if (marker.options.isExactPin) {
                        return;
                    }

                    // Handle regular shul marker clicks
                    const shulId = marker.options.shulId;
                    if (!shulId) return;

                    const clusterKey = window.SHUL_MAP_API.shulToClusterKey[shulId];
                    const popupContent = window.SHUL_MAP_API.clusterPopupHtmlMap?.[clusterKey];

                    if (!popupContent) {
                        console.error('No popup found for cluster key:', clusterKey);
                        return;
                    }

                    setupClusterPopup(marker, clusterKey, popupContent);
                });

                // ============================================================================
                // MARKER HANDLING
                // ============================================================================

                const markersByPopupId = {};

                function singleClusterIcon() {
                    return L.divIcon({
                        html: `<div class="marker-cluster marker-cluster-single"><span>1</span></div>`,
                        className: 'marker-cluster-wrapper',
                        iconSize: [38, 38],
                    });
                }

                const addMarker = (shulId, lat, lon, popupId) => {
                    const marker = L.marker([lat, lon], { icon: singleClusterIcon() });
                    marker.options.shulId = shulId;
                    marker.options.popupId = popupId;
                    markersLayer.addLayer(marker);
                    markersByPopupId[String(popupId)] = marker;
                    return marker;
                };

                const clearMarkers = () => {
                    markersLayer.clearLayers();
                    for (const k in markersByPopupId) delete markersByPopupId[k];
                    exactPinMarker = null;
                };

                // ============================================================================
                // EXACT PIN HANDLING
                // ============================================================================

                const addExactPin = (lat, lon, popupHtml) => {
                    // Create marker with explicit icon path
                    const defaultIcon = L.icon({
                        iconUrl: '{% static "eznashdb/images/marker-icon.png" %}',
                        shadowUrl: '{% static "eznashdb/images/marker-shadow.png" %}',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -27],
                        shadowSize: [41, 41]
                    });

                    const marker = L.marker([lat, lon], { icon: defaultIcon, isExactPin: true });

                    // Add to markersLayer so it clusters naturally with nearby markers
                    markersLayer.addLayer(marker);
                    markersLayer.addLayer(L.marker([lat, lon - 360], { icon: defaultIcon, isExactPin: true }));
                    markersLayer.addLayer(L.marker([lat, lon + 360], { icon: defaultIcon, isExactPin: true }));

                    exactPinMarker = marker;

                    if (popupHtml) {
                        // Store popup HTML for later use
                        marker._exactPopupHtml = popupHtml;

                        // Add click handler that dynamically handles screen size
                        marker.on('click', (e) => {
                            if (isSmallScreen()) {
                                // Prevent popup from opening
                                L.DomEvent.stop(e);

                                // Small screen - use offcanvas
                                const offcanvasEl = document.getElementById("shulOffcanvas");

                                // Dispose any existing offcanvas instance
                                const existingOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasEl);
                                if (existingOffcanvas) {
                                    existingOffcanvas.dispose();
                                }

                                offcanvasEl.querySelector(".offcanvas-body").innerHTML = popupHtml;

                                const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
                                offcanvasEl.addEventListener('hidden.bs.offcanvas', () => {
                                    URL_PARAMS_API.delete(["selectedCluster", "selectedShul"]);
                                }, { once: true });
                                bsOffcanvas.show();

                                const closeBtn = offcanvasEl.querySelector(".shul-popup-close");
                                if (closeBtn) {
                                    closeBtn.addEventListener("click", (ev) => {
                                        ev.preventDefault();
                                        bsOffcanvas.hide();
                                    });
                                }
                            } else {
                                // Large screen - bind popup and open
                                marker.bindPopup(popupHtml, {
                                    className: "shul-cluster-popup",
                                    closeButton: false,
                                    offset: [0, -7],
                                });
                                marker.openPopup();
                            }
                        });

                        // Setup close button and unbind on close
                        marker.on('popupopen', () => {
                            setTimeout(() => {
                                const popupEl = marker.getPopup().getElement();
                                if (!popupEl) return;

                                const closeBtn = popupEl.querySelector(".shul-popup-close");
                                if (closeBtn) {
                                    closeBtn.addEventListener("click", (ev) => {
                                        ev.preventDefault();
                                        marker.closePopup();
                                    });
                                }
                            }, 0);
                        });
                    }

                    return marker;
                };

                const openExactPin = () => {
                    if (!exactPinMarker) return;

                    // Click the marker - this will trigger the dynamic screen size check
                    exactPinMarker.fire('click');
                };

                // ============================================================================
                // OPEN SELECTED MARKER ON PAGE LOAD
                // ============================================================================

                const openSelectedMarker = () => {
                    const api = window.SHUL_MAP_API;
                    const selectedShulId = urlParams.get("selectedShul");
                    const selectedCluster = urlParams.get("selectedCluster");

                    if (selectedShulId) {
                        const clusterKey = api.shulToClusterKey[selectedShulId];
                        if (!clusterKey) return;

                        const target = api.markersByPopupId[String(selectedShulId)];
                        if (!target) return;

                        const cluster = api.markersLayer.getVisibleParent(target);

                        if (cluster && cluster instanceof L.MarkerCluster) {
                            // Click cluster and expand specific accordion
                            cluster._icon?.click();

                            setTimeout(() => {
                                const accordionItem = document.querySelector(`#shul-${selectedShulId}`);
                                if (accordionItem && !accordionItem.classList.contains('show')) {
                                    new bootstrap.Collapse(accordionItem, { toggle: true });
                                }
                            }, 200);
                        } else {
                            // Single marker
                            api.markersLayer.fire('click', { layer: target });
                        }
                    } else if (selectedCluster) {
                        // Open cluster without expanding any accordion
                        const shulIdInCluster = Object.keys(api.shulToClusterKey).find(
                            id => api.shulToClusterKey[id] === selectedCluster
                        );

                        if (shulIdInCluster) {
                            const target = api.markersByPopupId[String(shulIdInCluster)];
                            if (target) {
                                const cluster = api.markersLayer.getVisibleParent(target);
                                if (cluster && cluster instanceof L.MarkerCluster) {
                                    cluster._icon?.click();
                                } else {
                                    api.markersLayer.fire('click', { layer: target });
                                }
                            }
                        }
                    }
                };

            function initShulAccordion(item, shulId) {
                const collapseEl = item.querySelector('.accordion-collapse');

                collapseEl.addEventListener('show.bs.collapse', () => {
                    URL_PARAMS_API.update({ 'selectedShul': shulId });
                });

                collapseEl.addEventListener('shown.bs.collapse', () => {
                    if (window.SHUL_MAP_API?.map) {
                        setTimeout(() => {
                            const openPopup = window.SHUL_MAP_API.map._popup;
                            if (openPopup && openPopup._adjustPan) openPopup._adjustPan();
                        }, 100);
                    }

                    // Scroll within the popup container only
                    const header = item.querySelector('.accordion-header');
                    scrollIntoViewWithinContainer(header, {
                        behavior: 'smooth',
                        block: 'start',
                        offset: 15
                    });
                });

                collapseEl.addEventListener('hide.bs.collapse', () => {
                    const isClosingActiveRoom = URL_PARAMS_API.get('selectedShul') === String(shulId);
                    if (isClosingActiveRoom) URL_PARAMS_API.delete(['selectedShul']);
                });
            }

                // ============================================================================
                // EXPOSE API
                // ============================================================================

                window.SHUL_MAP_API = {
                    ...(window.SHUL_MAP_API || {}),
                    map,
                    markersLayer,
                    markersByPopupId,
                    addMarker,
                    clearMarkers,
                    addExactPin,
                    openExactPin,
                    openSelectedMarker,
                    initShulAccordion,
                };
            };

            // Initialize map and filter toggle when DOM is ready
            document.addEventListener("DOMContentLoaded", () => {
                initMap();
                FILTER_TOGGLE_API.init();
            });
        })();
    </script>
    {% partialdef map_updates inline=True %}
    <div class="d-none">{% include "eznashdb/includes/shuls_count.html" %}</div>
    <script id="shul-markers-js" hx-swap-oob="true" defer>
        (() => {
            document.dispatchEvent(new Event("shulsDataLoaded"));

            // ============================================================================
            // ADD SHUL MARKERS TO MAP
            // ============================================================================

            const addShulMarkers = () => {
                const mapApi = window.SHUL_MAP_API;
                const shulToClusterKey = {};

                // Store cluster offset info
                {% if cluster_offset %}
                    const clusterOffset = {
                        clusterKey: "{{ cluster_offset.cluster_key }}",
                        offsetLon: {{ cluster_offset.offset_lon }}
                    };
                {% else %}
                    const clusterOffset = null;
                {% endif %}

                // Add individual shul markers
                {% for shul in clustered_shuls_list %}
                    const clusterKey_{{ shul.id }} = "{{ shul.display_lat }}_{{ shul.display_lon }}";
                    shulToClusterKey["{{ shul.id }}"] = clusterKey_{{ shul.id }};

                    (() => {
                        const id = {{ shul.id }};
                        let lat = parseFloat({{ shul.display_lat }});
                        let lon = parseFloat({{ shul.display_lon }});

                        // Apply cluster offset if applicable (horizontal only)
                        if (clusterOffset && clusterKey_{{ shul.id }} === clusterOffset.clusterKey) {
                            lon += clusterOffset.offsetLon;
                        }

                        // Add three variants for world wrap-around
                        mapApi.addMarker(id, lat, lon, String(id));
                        mapApi.addMarker(id, lat, lon - 360, "-" + String(id));
                        mapApi.addMarker(id, lat, lon + 360, "+" + String(id));
                    })();
                {% endfor %}

                // Build cluster popups for ALL shuls (including singles)
                const clusterPopupHtmlMap = {};
                {% for cluster_key, shuls in shul_clusters.items %}
                    clusterPopupHtmlMap["{{ cluster_key }}"] = `{% include "eznashdb/includes/shul_cluster_popup.html" with shuls=shuls %}`;
                {% endfor %}

                mapApi.clusterPopupHtmlMap = clusterPopupHtmlMap;
                mapApi.shulToClusterKey = shulToClusterKey;

                // Add exact pin popup HTML if present
                {% if exact_pin_shul %}
                    mapApi.exactPinPopupHtml = `{% include "eznashdb/includes/exact_pin_popup.html" with shul=exact_pin_shul %}`;
                    mapApi.exactPinShulId = {{ exact_pin_shul.id }};
                    mapApi.exactPinLat = {{ exact_pin_shul.latitude }};
                    mapApi.exactPinLon = {{ exact_pin_shul.longitude }};
                {% else %}
                    mapApi.exactPinPopupHtml = null;
                {% endif %}
            };

            // ============================================================================
            // REPLACE MAP SHULS (CALLED ON FILTER CHANGE)
            // ============================================================================

            const replaceMapShuls = () => {
                const mapApi = window.SHUL_MAP_API;
                mapApi.clearMarkers();
                addShulMarkers();

                // Add and open exact pin if present
                if (mapApi.exactPinPopupHtml && mapApi.exactPinLat && mapApi.exactPinLon) {
                    mapApi.addExactPin(mapApi.exactPinLat, mapApi.exactPinLon, mapApi.exactPinPopupHtml);
                    mapApi.openExactPin();

                    // Delete URL params immediately so pin disappears on refresh
                    setTimeout(() => {
                        URL_PARAMS_API.delete(["justSaved"]);
                    }, 100);
                } else {
                    mapApi.openSelectedMarker();
                }
            };

            // ============================================================================
            // EXPOSE API AND INITIALIZE
            // ============================================================================

            window.SHUL_MAP_API = {
                ...window.SHUL_MAP_API,
                addShulMarkers,
                replaceMapShuls,
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    window.SHUL_MAP_API.replaceMapShuls();
                });
            } else {
                window.SHUL_MAP_API.replaceMapShuls();
            }
        })();
    </script>
{% endpartialdef map_updates %}
<script defer src="{% static 'eznashdb/js/map_spinner.js' %}"></script>
{% endblock extra_media_bottom %}
