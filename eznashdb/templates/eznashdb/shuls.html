{% extends "base.html" %}

{% load static %}
{% load partials %}

{% block extra_media_top %}
    <link rel="stylesheet" href="{% static 'eznashdb/css/shuls.css' %}">
{% endblock extra_media_top %}

{% block content %}
    <div class="row h-100">
        <div class="col h-100 d-flex flex-column">
            <div class="row mb-1">
                <div class="col-6">
                    <h4>Browse Shuls</h4>
                </div>
                <div class="col-6 d-flex flex-column align-items-end">
                    <span class="text-nowrap">
                        <a href="{% url 'eznashdb:create_shul' %}" class="btn btn-primary "><i class="fa fa-plus"></i> Add a Shul</a>
                    </span>
                </div>
            </div>
            <div class="row">{% include "eznashdb/includes/shul_filters.html" %}</div>
            <div class="row flex-grow-1">
                <div class="col-12">
                    <div class="border rounded h-100 position-relative">
                        <span class="spinner-overlay bg-secondary w-100 h-100 rounded text-center d-flex align-items-center opacity-0">
                            <div class="flex-grow-1 text-center">
                                <span class="spinner-border spinner-border-lg"
                                      style="width: 3rem;
                                             height: 3rem"
                                      role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </span>
                            </div>
                        </span>
                        <div id="shuls-map" class="h-100"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="offcanvas offcanvas-bottom p-0 rounded-top h-auto"
             tabindex="-1"
             id="shulOffcanvas"
             aria-labelledby="shulOffcanvasLabel">
            <div class="offcanvas-body p-0"></div>
        </div>
    </div>
{% endblock %}

{% block extra_media_bottom %}
    {{ block.super }}
    <script defer>
        (() => {
            // Utilities for URL param management
            const updateURLParams = (params) => {
                const url = new URL(window.location.href);
                for (const key in params) url.searchParams.set(key, params[key]);
                history.replaceState({}, "", url.toString());
            };
            const deleteURLParams = (params) => {
                const url = new URL(window.location.href);
                params.forEach((param) => url.searchParams.delete(param));
                history.replaceState({}, "", url.toString());
            };

            const updateURLLocationParams = (map) => {
                const center = map.getCenter();
                updateURLParams({
                lat: center.lat,
                lon: center.lng,
                zoom: map.getZoom(),
                });
            };

            const isSmallScreen = () => {
                return window.innerWidth < 768 || window.innerHeight < 600;
            }

            const initMap = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const mapId = "shuls-map";
                const startLat = parseFloat(urlParams.get("lat")) || 20;
                const startLon = parseFloat(urlParams.get("lon")) || 10;
                const startZoom = parseInt(urlParams.get("zoom"), 10) || 2;

                const map = L.map(mapId, {
                    center: [startLat, startLon],
                    zoom: startZoom,
                    scrollWheelZoom: true,
                    worldCopyJump: true,
                    minZoom: 1,
                    zoomControl: false,
                });

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?", {
                attribution:
                    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                }).addTo(map);
                L.control.zoom({ position: "bottomleft" }).addTo(map);
                document.getElementById(mapId).classList.add("rounded");

                map.whenReady(() => {
                // small delay allows CSS/layout to finish
                    setTimeout(() => map.invalidateSize(), 150);
                });

                            // Keep URL in sync with map movements and popup state
                map.on("moveend", () => updateURLLocationParams(map));
                map.on("zoomend", () => updateURLLocationParams(map));
                map.on("popupclose", () => {
                    // Only remove selectedShul param on large screens where popup was actually used
                    if (!isSmallScreen()) {
                        deleteURLParams(["selectedShul"]);
}                });

                const markersLayer = L.markerClusterGroup({
                    showCoverageOnHover: false,
                    spiderfyOnMaxZoom: false, // Don't spiderfy - show combined popup instead
                    zoomToBoundsOnClick: false, // Don't zoom - show popup instead
                    spiderfyDistanceMultiplier: 0,
                    disableClusteringAtZoom: null,
                });
                // Disable spiderfy completely
                markersLayer.on('spiderfied', function(e) {
                    e.preventDefault();
                    return false;
                });
                map.addLayer(markersLayer);

                // Handle cluster clicks - show combined popup for grouped shuls
markersLayer.on('clusterclick', function(cluster) {
    const childMarkers = cluster.layer.getAllChildMarkers();

    // Check if all markers are for the same location (same display_lat/lon)
    const firstPos = childMarkers[0].getLatLng();
    const allSamePosition = childMarkers.every(m => {
        const pos = m.getLatLng();
        return Math.abs(pos.lat - firstPos.lat) < 0.0001 &&
               Math.abs(pos.lng - firstPos.lng) < 0.0001;
    });

    if (!allSamePosition) {
        // Regular cluster (different locations) - zoom in
        cluster.layer.zoomToBounds({ padding: [20, 20] });
        return;
    }

    // Get grid key from position
    const gridKey = `${firstPos.lat}_${firstPos.lng}`;
    const popupContent = window.SHUL_MAP_API.clusterPopupHtmlMap?.[gridKey];

    if (!popupContent) {
        console.error('No cluster popup found for grid key:', gridKey);
        return;
    }

    // Get unique shul IDs in this cluster
    const uniqueShulIds = new Set();
    childMarkers.forEach(marker => {
        const shulId = marker.getPopup().options.shulId;
        uniqueShulIds.add(shulId);
    });

    cluster.layer.bindPopup(popupContent, {
        className: "shul-popup shul-cluster-popup",
        closeButton: false,
        maxHeight: 400,
        gridKey: gridKey,
        shulIds: Array.from(uniqueShulIds),
    }).openPopup();

    // Update URL params
    updateURLParams({ selectedCluster: gridKey });

    // Set up close button
    setTimeout(() => {
        const popupEl = cluster.layer.getPopup().getElement();
        if (popupEl) {
            const closeBtn = popupEl.querySelector(".shul-popup-close");
            if (closeBtn) {
                closeBtn.addEventListener("click", (ev) => {
                    ev.preventDefault();
                    cluster.layer.closePopup();
                });
            }

            // Set up accordion item listeners
            setupAccordionListeners(popupEl, Array.from(uniqueShulIds));
        }
    }, 0);
});

// Handle popup close - remove URL params
map.on("popupclose", (e) => {
    const popup = e.popup;
    if (popup.options.gridKey) {
        // Cluster popup closed
        deleteURLParams(["selectedCluster", "selectedShul"]);
    } else if (!isSmallScreen()) {
        // Single shul popup closed (large screen)
        deleteURLParams(["selectedShul"]);
    }
});

function setupAccordionListeners(popupEl, shulIds) {
    const accordionEl = popupEl.querySelector('#clusterShulsAccordion');
    if (!accordionEl) return;

    shulIds.forEach(shulId => {
        const collapseEl = popupEl.querySelector(`#shul-${shulId}`);
        if (!collapseEl) return;

        collapseEl.addEventListener('shown.bs.collapse', () => {
            updateURLParams({ selectedShul: shulId });
        });

        collapseEl.addEventListener('hidden.bs.collapse', () => {
            // Check if any accordion items are still open
            const anyOpen = popupEl.querySelector('.accordion-collapse.show');
            if (!anyOpen) {
                deleteURLParams(["selectedShul"]);
            }
        });
    });
}

                const popupHtmlMap = {};      // keyed by shul id (string) -> html string
                const markersByPopupId = {};  // keyed by popupId (string like '123', '+123', '-123') -> marker instance

                function singleClusterIcon() {
                    return L.divIcon({
                        html: `<div class="marker-cluster marker-cluster-single">
                                <span>1</span>
                            </div>`,
                        className: 'marker-cluster-wrapper',
                        iconSize: [38, 38],
                        popupAnchor: [0, -13],
                    });
                }

                const addMarker = (shulId, lat, lon, popupId) => {
                    const popupHtml = popupHtmlMap[String(shulId)] || "";
                    const marker = L.marker([lat, lon], { icon: singleClusterIcon() });

                    // Bind popup once during marker creation (for large screens)
                    marker.bindPopup(popupHtml, {
                        className: "shul-popup",
                        closeButton: false,
                        shulId: shulId,
                        popupId: popupId,
                    });
                    // Remove Leaflet's default onclick handler
                    marker.off('click')
                    marker.on("click", (e) => {
                        gtag('event', 'marker_click', {
                            'shul_id': shulId,
                        });
                        if (isSmallScreen()) {
                            // Small screen → use Bootstrap offcanvas
                            const offcanvasEl = document.getElementById("shulOffcanvas");
                            offcanvasEl.querySelector(".offcanvas-body").innerHTML = popupHtml;

                            const bsOffcanvas = new bootstrap.Offcanvas(offcanvasEl);
                            // Remove URL param when offcanvas is hidden
                            offcanvasEl.addEventListener('hidden.bs.offcanvas', () => {
                                deleteURLParams(["selectedShul"]);
                            }, { once: true });
                            bsOffcanvas.show();

                            const closeBtn = offcanvasEl.querySelector(".shul-popup-close");
                            if (closeBtn) {
                                closeBtn.addEventListener("click", (ev) => {
                                    ev.preventDefault();
                                    bsOffcanvas.hide();
                                });
                            }
                        } else {
                            // Large screen → open the already-bound popup
                            marker.openPopup();
                            // Set up close button listener after popup opens
                            setTimeout(() => {
                                const popupEl = marker.getPopup().getElement();
                                if (popupEl) {
                                    const closeBtn = popupEl.querySelector(".shul-popup-close");
                                    if (closeBtn) {
                                        closeBtn.addEventListener("click", (ev) => {
                                            ev.preventDefault();
                                            marker.closePopup();
                                        });
                                    }
                                }
                            }, 0);
                        }
                        updateURLParams({ selectedShul: shulId });
                    });

                    markersLayer.addLayer(marker);
                    markersByPopupId[String(popupId)] = marker;
                    return marker;
                }

                const clearMarkers = () => {
                    markersLayer.clearLayers();
                    for (const k in markersByPopupId) delete markersByPopupId[k];
                }

                const replaceMarkers = (markersData) => {
                    clearMarkers();
                    markersData.forEach((md) => {
                    addMarker(md.id, md.lat, md.lon, md.popupId);
                    });
                }

const openSelectedMarker = () => {
    const api = window.SHUL_MAP_API;
    const selectedShulId = urlParams.get("selectedShul");
    const selectedCluster = urlParams.get("selectedCluster");

    if (selectedShulId) {
        // Find which cluster/grid this shul belongs to
        const gridKey = api.shulToGridKey[selectedShulId];

        if (!gridKey) return;

        // Find a marker at this grid location
        const target = api.markersByPopupId[String(selectedShulId)];
        if (!target) return;

        // Check if this is in a cluster
        const cluster = api.markersLayer.getVisibleParent(target);

        if (cluster && cluster instanceof L.MarkerCluster) {
            // Click the cluster icon
            const clusterIcon = cluster._icon;
            if (clusterIcon) {
                clusterIcon.click();
            }

// After cluster popup opens, expand the specific shul's accordion
setTimeout(() => {
    const accordionItem = document.querySelector(`#shul-${selectedShulId}`);
    if (accordionItem && !accordionItem.classList.contains('show')) {
        const collapse = new bootstrap.Collapse(accordionItem, { toggle: true });

        // Scroll into view after accordion opens
        accordionItem.addEventListener('shown.bs.collapse', () => {
            accordionItem.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, { once: true });
    }
}, 200);
        } else {
            // Not in a cluster - open normally
            setTimeout(() => target.fire('click'), 0);
        }
    } else if (selectedCluster) {
        // Just open the cluster without expanding any accordion
        // Find any shul in this cluster to trigger it
        const shulIdInCluster = Object.keys(api.shulToGridKey).find(
            id => api.shulToGridKey[id] === selectedCluster
        );

        console.log('Found shul in cluster:', shulIdInCluster);

        if (shulIdInCluster) {
            const target = api.markersByPopupId[String(shulIdInCluster)];
            console.log('Target marker:', target);

            if (target) {
                const cluster = api.markersLayer.getVisibleParent(target);
                console.log('Cluster:', cluster);
                console.log('Is MarkerCluster?', cluster instanceof L.MarkerCluster);

                if (cluster && cluster instanceof L.MarkerCluster) {
                    // Just fire the click - don't use zoomToShowLayer

                        const clusterIcon = cluster._icon;
                        if (clusterIcon) {
                            clusterIcon.click();
                        } else {
                            // Fallback: fire the event manually
                            api.markersLayer.fire('clusterclick', {
                                layer: cluster
                            });
                        }
                } else {
                    console.log('Not in a cluster at this zoom level');
                }
            }
        }
    }
}

                window.SHUL_MAP_API = {
                    ...(window.SHUL_MAP_API || {}),
                    map,
                    markersLayer,
                    popupHtmlMap,
                    markersByPopupId,
                    addMarker,
                    clearMarkers,
                    replaceMarkers,
                    openSelectedMarker,
                }
            }

            // Map initialization when DOM is ready
            document.addEventListener("DOMContentLoaded", () => {
                initMap();
            });
        })();
    </script>
    {% partialdef shul_markers_js inline=True %}
    <script id="shul-markers-js" hx-swap-oob="true" defer>
        (() => {
            document.dispatchEvent(new Event("shulsDataLoaded"));
            const updateShulsFoundCount = () => {
                if (window.SHUL_MAP_API.shulsFoundControl) {
                    window.SHUL_MAP_API.shulsFoundControl.remove();
                }
                const map = window.SHUL_MAP_API.map;
                // ---- Shuls-found control (topright) ----
                const shulsFoundControl = L.control({ position: "topright" });
                shulsFoundControl.onAdd = function () {
                    const container = L.DomUtil.create("div", "shuls-found-control");
                    container.style.cursor = "initial";
                    const shulCount = {{object_list.count}};
                    const shulCountMsg = `${shulCount} ${shulCount === 1 ? "shul" : "shuls"} found`;
                    container.innerHTML = `
                        <div class="fw-normal fs-5 opacity-75">
                            <span class="badge bg-dark">${shulCountMsg}</span>
                        </div>`;
                    L.DomEvent.disableClickPropagation(container);
                    L.DomEvent.disableScrollPropagation(container);
                    return container;
                };
                shulsFoundControl.addTo(map);
                window.SHUL_MAP_API.shulsFoundControl = shulsFoundControl
            }

const addShulMarkers = () => {
    const mapApi = window.SHUL_MAP_API;

    // Build individual shul popups AND store grid key for each shul
    const shulToGridKey = {};

    {% for shul in object_list %}
        mapApi.popupHtmlMap["{{ shul.id }}"] = `{% include "eznashdb/includes/shul_popup.html" %}`;
        shulToGridKey["{{ shul.id }}"] = "{{ shul.display_lat }}_{{ shul.display_lon }}";

        // Add the three wrap-around variants (original, -360, +360)
        (() => {
            const id = {{ shul.id }};
            const lat = parseFloat({{ shul.display_lat }});
            const lon = parseFloat({{ shul.display_lon }});
            // original
            mapApi.addMarker(id, lat, lon, String(id));
            // wrap-around west
            mapApi.addMarker(id, lat, lon - 360, "-" + String(id));
            // wrap-around east
            mapApi.addMarker(id, lat, lon + 360, "+" + String(id));
        })();
    {% endfor %}

    // Build cluster popups (for groups with 2+ shuls)
    const clusterPopupHtmlMap = {};
    {% for grid_key, shuls in cluster_groups.items %}
        {% if shuls|length > 1 %}
            clusterPopupHtmlMap["{{ grid_key }}"] = `{% include "eznashdb/includes/shul_cluster_popup.html" with shuls=shuls %}`;
        {% endif %}
    {% endfor %}

    mapApi.clusterPopupHtmlMap = clusterPopupHtmlMap;
    mapApi.shulToGridKey = shulToGridKey;
}

            const replaceMapShuls = () => {
                const mapApi = window.SHUL_MAP_API;
                mapApi.clearMarkers()
                updateShulsFoundCount();
                addShulMarkers();
                mapApi.openSelectedMarker();
            }

            window.SHUL_MAP_API = {
                ...window.SHUL_MAP_API,
                updateShulsFoundCount,
                addShulMarkers,
                replaceMapShuls,
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    window.SHUL_MAP_API.replaceMapShuls();
                });
            } else {
                window.SHUL_MAP_API.replaceMapShuls();
            }
        })()
    </script>
{% endpartialdef shul_markers_js %}
<script defer src="{% static 'eznashdb/js/map_spinner.js' %}"></script>
{% endblock extra_media_bottom %}
