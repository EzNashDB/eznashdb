{% extends "base.html" %}

{% load static %}
{% load crispy_forms_tags %}
{% load partials %}

{% block title %}
    The Ezrat Nashim Database -
    {% if not form.instance.pk %}
        Add
    {% else %}
        Update
    {% endif %}
    Shul
{% endblock %}

{% block content %}
    <div class="row" id="shul-form-state"
        {# djlint:off #}
        x-data="{ dirtyFields: new Set() }"
        x-init="
            window.onbeforeunload = (e) => {
                if (window.htmxSubmitting) return;
                // Trigger warning if dirty fields OR in step 2 OR has form errors
                if (dirtyFields.size > 0 || '{{ wizard_step }}' === '2' || !!'{{form.errors|escapejs}}') {
                    return '';
                }
            }
        "
        {# djlint:on #}
        >
        <div class="col h-100">
            {% partialdef shul_form inline=True %}
            <form method="POST"
                  enctype="multipart/form-data"
                  novalidate
                  id="shul_form"
                  class="row h-100"
                  @input="dirtyFields.add($event.target.name)"
                  @change="dirtyFields.add($event.target.name)">
                {% csrf_token %}
                {# Hidden field to track wizard step - server controls the value #}
                {% if not object %}<input type="hidden" name="wizard_step" value="{{ wizard_step }}">{% endif %}
                <div class="col h-100 d-flex flex-column">
                    <div class="row sticky-top bg-body py-2 border-bottom"
                         style="{# Below bootstrap modal + navbar, above map inputs #} z-index: 1025">
                        <div class="col-12">
                            <h3 class="d-flex gap-3 align-items-center mb-0">
                                {% if object %}
                                    Edit Shul: {{ object.name }}
                                {% else %}
                                    Add a Shul
                                    <span class="h5 m-0">
                                        <span class="badge text-bg-info">Step {{ wizard_step }} of 2</span>
                                    </span>
                                {% endif %}
                            </h3>
                        </div>
                    </div>
                    <div class="row flex-grow-1 max-h-fit">
                        <div class="col-12 h-100">
                            <div class="row">
                                <div class="col-12">
                                    <div class="row">
                                        <div class="col-12 col-md-5 col-lg-4">
                                            <div class="mt-3">{% crispy form %}</div>
                                        </div>
                                        {% if form.instance.pk or wizard_step == '2' %}
                                            <div class="col">
                                                <div class="row">
                                                    <h5 class="col-12 pt-3 mb-2" id="rooms-form-header">Rooms</h5>
                                                </div>
                                                <div class="row mb-3">
                                                    {{ room_fs.management_form }}
                                                    {% for error in room_fs.non_form_errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
                                                    <div class="room-formset accordion" id="roomsAccordion" x-data="{ openRoom:
                                                        {% if not shul.rooms.exists %}
                                                            'rooms-0-form'
                                                        {% else %}
                                                            null
                                                        {% endif %}
                                                        }">
                                                        {% for form in room_fs %}
                                                            {% crispy form %}
                                                        {% endfor %}
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="row justify-content-end">
                                                            <div class="add-room-container col-12 d-flex justify-content-end"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-md-10 col-lg-8 col-xl-6 mx-auto">
                            <div class="row ">
                                <div class="col-12 col-md-6 order-md-1 mt-3">
                                    <button type="submit"
                                        class="btn btn-primary w-100"
                                        {# djlint:off #}
                                            hx-vals='js:{
                                                "check_nearby_shuls": (() => {
                                                    const dirtyFields = Alpine.$data(document.getElementById("shul-form-state")).dirtyFields;
                                                    return dirtyFields.has("latitude") || dirtyFields.has("longitude");
                                                })(),
                                            }'
                                        {# djlint:on #}
                                        hx-post='{{ request.path }}'
                                        hx-target='#shul_form'
                                        hx-swap='outerHTML'>
                                        {% if wizard_step == '1' %}
                                            Next: Add Rooms
                                            <i class="ms-2 fa-solid fa-arrow-right"></i>
                                        {% else %}
                                            Save
                                        {% endif %}
                                    </button>
                                </div>
                                <div class="col-12 col-md-6 order-md-0 mb-2 mb-md-0 mt-3">
                                    <a href="/" class="btn btn-outline-secondary w-100">
                                        <i class="fa-solid fa-arrow-left me-2"></i>
                                        Back to Home
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% if nearby_shuls %}
                    {% include "eznashdb/includes/nearby_shuls_modal.html" %}
                {% endif %}
                <script>
                    window.shulForm = {
                        errors: JSON.parse("{{ form.errors.as_json|escapejs }}"),
                    }
                </script>
                <script defer src="{% static 'dist/createUpdateShul.js' %}"></script>
            </form>
        {% endpartialdef %}
    </div>
</div>
{% endblock content %}

{% block extra_media_bottom %}
    {{ block.super }}
    <script type="text/javascript">
    window.htmxSubmitting = false;
    document.body.addEventListener("htmx:beforeRequest", (e) => {
        if (e.target?.type === 'submit') window.htmxSubmitting = true;
    });
    // Reset htmxSubmitting after request completes
    document.body.addEventListener("htmx:afterRequest", (e) => {
        window.htmxSubmitting = false;
    });

    // Show nearby shuls modal after settling (animations complete)
    document.addEventListener("htmx:afterSettle", (e) =>{
        const modalEl = document.getElementById('nearby-shuls-modal');
        if (modalEl) {
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    });

    const getWizardStep = () => {
        const wizardStepInput = document.querySelector('input[name="wizard_step"]');
        return wizardStepInput ? wizardStepInput.value : null;
    };

    const initRoomFormSet = () => {
        const isStep2 = getWizardStep() === '2';
        const isUpdateMode = {% if object %}true{% else %}false{% endif %};

        if (!isStep2 && !isUpdateMode) return;

        // Clean up any existing formset buttons before initializing
        // This handles the case where initRoomFormSet is called multiple times
        $('.add-room-container').empty();
        $('.delete-room-container .delete-room').remove();

        $('.room-form').formset({
            modelName: "room",
            formCssClass: 'room-form',
            formsParentCssClass: 'room-formset',
            prefix: '{{ room_fs.prefix }}',
            addCssClass:'btn btn-secondary form-text mt-2',
            addText: '<i class="fa fa-plus"></i> Add another room',
            addContainerClass: 'add-room-container',
            deleteCssClass:'delete-room btn btn-sm btn-outline-danger mt-3',
            deleteText: '<i class="fa fa-times"></i> Delete room',
            deleteContainerClass: 'delete-room-container',
            hideLastAddForm: {% if room_fs.1 %} true {% else %} false {% endif %},
            prepareTemplate: (template) => {
                const collapseEl = template.find('.accordion-collapse');
                collapseEl.removeClass('show');
            },
            added: (row) => {
                const accordion = document.getElementById('roomsAccordion');
                const alpineData = Alpine.$data(accordion);
                alpineData.openRoom = row.attr('id');
                const collapseEl = row.find('.accordion-collapse')[0];
                new bootstrap.Collapse(collapseEl, {show: true});
            },
        });
    }
    document.addEventListener("DOMContentLoaded", initRoomFormSet);

    // Only reinitialize formset when the form itself is swapped by HTMX
    document.body.addEventListener("htmx:afterSettle", initRoomFormSet);
    document.addEventListener("htmx:load", () => {
        if (getWizardStep() === '2') {
            const roomCollapseEl = document.querySelector('.room-form .accordion-collapse');
            const header = document.getElementById('rooms-form-header');

            if (!roomCollapseEl || !header) return;

            const scrollToHeader = () => {
                // Add offset to account for sticky header height
                scrollIntoViewWithinContainer(header, { behavior: 'smooth', block: 'start', offset: 40 })
            };

            if (!roomCollapseEl.classList.contains('show')) {
                const roomCollapse = new bootstrap.Collapse(roomCollapseEl, {show: false});
                roomCollapseEl.addEventListener('shown.bs.collapse', scrollToHeader, { once: true });
                roomCollapse.show();
            } else {
                // Already open - wait for layout to stabilize before scrolling
                requestAnimationFrame(() => {
                    requestAnimationFrame(scrollToHeader);
                });
            }
        }
    })
    </script>
{% endblock extra_media_bottom %}
