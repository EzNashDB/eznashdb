{% extends "base.html" %}

{% load static %}
{% load crispy_forms_tags %}
{% load partials %}

{% block title %}
    {% if not form.instance.pk %}
        Add
    {% else %}
        Update
    {% endif %}
    Shul | The Ezrat Nashim Database
{% endblock %}

{% block content %}
    <div class="row" id="shul-form-state"
        {# djlint:off #}
        x-data="{ dirtyFields: new Set() }"
        x-init="
            window.onbeforeunload = (e) => {
                if (window.htmxSubmitting) return;
                // Trigger warning if dirty fields OR in step 2 OR has form errors
                if (dirtyFields.size > 0 || '{{ wizard_step }}' === '2' || !!'{{form.errors|escapejs}}') {
                    return '';
                }
            }
        "
        {# djlint:on #}
        >
        <div class="col col-md-8 col-lg-11 col-xl-10 col-xxl-9 m-auto h-100">
            {% partialdef shul_form inline=True %}
            <form method="POST"
                  enctype="multipart/form-data"
                  novalidate
                  id="shul_form"
                  class="row h-100"
                  @input="dirtyFields.add($event.target.name)"
                  @change="dirtyFields.add($event.target.name)">
                {% csrf_token %}
                {# Hidden field to track wizard step - server controls the value #}
                {% if not object %}<input type="hidden" name="wizard_step" value="{{ wizard_step }}">{% endif %}
                <div class="col h-100 d-flex flex-column">
                    <div class="row sticky-top bg-body py-2 border-bottom"
                         style="{# Below bootstrap modal + navbar, above map inputs #} z-index: 1025">
                        <div class="col-12">
                            <h3 class="d-flex gap-3 justify-content-between align-items-center mb-0">
                                {% if object %}
                                    <span class="text-truncate">Edit Shul: {{ object.name }}</span>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger text-nowrap"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteModal">
                                        <i class="fa-solid fa-trash me-1"></i>Delete
                                    </button>
                                {% else %}
                                    <div class="d-flex gap-3 align-items-center">
                                        Add a Shul
                                        <span class="h5 m-0">
                                            <span class="badge text-bg-info">Step {{ wizard_step }} of 2</span>
                                        </span>
                                    </div>
                                {% endif %}
                            </h3>
                        </div>
                    </div>
                    <div class="row flex-grow-1 max-h-fit">
                        <div class="col-12 h-100">
                            <div class="row">
                                <div class="col-12">
                                    <div class="row">
                                        <div class="col-12 col-lg-5">
                                            <div class="mt-3">{% crispy form %}</div>
                                        </div>
                                        {% if form.instance.pk or wizard_step == '2' %}
                                            <div class="col">
                                                <div class="d-md-none">
                                                    <hr>
                                                </div>
                                                <div class="row">
                                                    <h5 class="col-12 pt-3 mb-2" id="rooms-form-header">Rooms</h5>
                                                </div>
                                                <div class="row mb-3">
                                                    {{ room_fs.management_form }}
                                                    {% for error in room_fs.non_form_errors %}<span class="text-danger">{{ error }}</span>{% endfor %}
                                                    <div class="room-formset accordion" id="roomsAccordion" x-data="{ openRoom:
                                                        {% if not shul.rooms.exists %}
                                                            'rooms-0-form'
                                                        {% else %}
                                                            null
                                                        {% endif %}
                                                        }">
                                                        {% for form in room_fs %}
                                                            {% crispy form %}
                                                        {% endfor %}
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="row justify-content-end">
                                                            <div class="add-room-container col-12 d-flex justify-content-end"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row border-top pt-3 mt-3">
                        <div class="col-12 d-flex flex-column flex-md-row justify-content-center align-items-center gap-2">
                            <a href="/" class="btn btn-link text-muted order-md-0 order-1">
                                <i class="fa-solid fa-arrow-left me-1"></i>Back to Home
                            </a>
                            <button type="submit"
                                class="btn btn-primary order-md-1 order-0 text-nowrap"
                                style="min-width: 200px;"
                                {# djlint:off #}
                                    hx-vals='js:{
                                        "check_nearby_shuls": (() => {
                                            const dirtyFields = Alpine.$data(document.getElementById("shul-form-state")).dirtyFields;
                                            return dirtyFields.has("latitude") || dirtyFields.has("longitude");
                                        })(),
                                    }'
                                {# djlint:on #}
                                hx-post='{{ request.path }}'
                                hx-target='#shul_form'
                                hx-swap='outerHTML'>
                                {% if wizard_step == '1' %}
                                    Next: Add Rooms
                                    <i class="ms-2 fa-solid fa-arrow-right"></i>
                                {% else %}
                                    Save
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>
                <script>
                    window.shulForm = {
                        errors: JSON.parse("{{ form.errors.as_json|escapejs }}"),
                    }
                </script>
                <script defer src="{% static 'dist/createUpdateShul.js' %}"></script>
                {% if nearby_shuls %}
                    {% include "eznashdb/includes/nearby_shuls_modal.html" %}
                {% endif %}
            </form>
        {% endpartialdef %}
    </div>
</div>
{% if object %}
    <div class="modal fade"
         id="deleteModal"
         tabindex="-1"
         aria-labelledby="deleteModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Delete Shul</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p class="text-muted">
                            The shul will be removed from public view immediately, but may be restored after review.
                        </p>
                        {% crispy delete_form %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="delete_shul" value="true" class="btn btn-danger">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endif %}
{% endblock content %}

{% block extra_media_bottom %}
    {{ block.super }}
    <script type="text/javascript">
    window.htmxSubmitting = false;
    document.body.addEventListener("htmx:beforeRequest", (e) => {
        if (e.target?.type === 'submit') window.htmxSubmitting = true;
    });
    // Reset htmxSubmitting after request completes
    document.body.addEventListener("htmx:afterRequest", (e) => {
        window.htmxSubmitting = false;
    });

    const getWizardStep = () => {
        const wizardStepInput = document.querySelector('input[name="wizard_step"]');
        return wizardStepInput ? wizardStepInput.value : null;
    };

    const initRoomFormset = function() {
        const formsetContainer = document.querySelector('.room-formset');

        // Only initialize if we have a formset and it hasn't been initialized yet
        if (!formsetContainer || formsetContainer.classList.contains('formset-initialized')) {
            return;
        }

        // Mark as initialized to prevent double init
        formsetContainer.classList.add('formset-initialized');

        // Initialize the formset
        $('.room-form').formset({
            modelName: "room",
            formCssClass: 'room-form',
            formsParentCssClass: 'room-formset',
            prefix: '{{ room_fs.prefix }}',
            addCssClass:'btn btn-secondary form-text mt-2',
            addText: '<i class="fa fa-plus"></i> Add another room',
            addContainerClass: 'add-room-container',
            deleteCssClass:'delete-room btn btn-sm btn-outline-danger mt-3',
            deleteText: '<i class="fa fa-trash"></i> Delete room',
            deleteContainerClass: 'delete-room-container',
            hideLastAddForm: {% if room_fs.1 %} true {% else %} false {% endif %},
            prepareTemplate: (template) => {
                const collapseEl = template.find('.accordion-collapse');
                collapseEl.removeClass('show');
            },
            added: (row) => {
                const accordion = document.getElementById('roomsAccordion');
                const alpineData = Alpine.$data(accordion);
                alpineData.openRoom = row.attr('id');
                const collapseEl = row.find('.accordion-collapse')[0];
                new bootstrap.Collapse(collapseEl, {show: true});
            },
        });
    }

    const showNearbyShuls = () => {
        const modalEl = document.getElementById('nearby-shuls-modal');
        if (modalEl) {
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();

            // Handle "Add New Anyway" button - hide modal before HTMX swap
            // Using htmx:confirm (not just for user confirmations - it's for any async request gating)
            const addNewButton = modalEl.querySelector('[hx-post]');
            if (addNewButton) {
                addNewButton.addEventListener('htmx:confirm', (confirmEvent) => {
                    confirmEvent.preventDefault();
                    // Wait for modal to fully hide before allowing HTMX request
                    modal.hide();
                    modalEl.addEventListener('hidden.bs.modal', () => {
                        confirmEvent.detail.issueRequest(true);
                    }, { once: true });
                });
            }
        }
    }

    const openStep2 = () => {
        // Clear dirtyFields when transitioning to step 2 so we only check
        // for nearby shuls if the address is changed ON step 2
        const formState = document.getElementById('shul-form-state');
        if (formState) {
            const alpineData = Alpine.$data(formState);
            alpineData.dirtyFields.clear();
        }

        const roomCollapseEl = document.querySelector('.room-form .accordion-collapse');
        const header = document.getElementById('rooms-form-header');

        if (!roomCollapseEl || !header) return;

        const scrollToHeader = () => {
            // Add offset to account for sticky header height
            scrollIntoViewWithinContainer(header, { behavior: 'smooth', block: 'start', offset: 40 })
        };

        if (!roomCollapseEl.classList.contains('show')) {
            const roomCollapse = new bootstrap.Collapse(roomCollapseEl, {show: false});
            roomCollapseEl.addEventListener('shown.bs.collapse', scrollToHeader, { once: true });
            roomCollapse.show();
        } else {
            // Already open - wait for layout to stabilize before scrolling
            requestAnimationFrame(() => {
                requestAnimationFrame(scrollToHeader);
            });
        }
    }

    document.addEventListener("DOMContentLoaded", initRoomFormset);
    document.addEventListener("htmx:afterSettle", (e) => {
        showNearbyShuls();
        initRoomFormset();
        if (getWizardStep() === '2') {
            openStep2();
        }
    });
    </script>
{% endblock extra_media_bottom %}
