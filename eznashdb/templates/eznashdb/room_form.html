{% load crispy_forms_tags %}
<div class="accordion-item room-form" id="{{ room_fs.prefix }}-{{ forloop.counter0 }}-form"
    {# djlint:off #}
        {% with dropdown_default="<kbd class='fw-bold'>?</kbd> - Not set" %}
        x-data='{
            roomName: "{{ form.instance.name }}",
            sizeBanner: "{{ form.instance.get_relative_size_display|safe|default:dropdown_default|escapejs }}",
            seeHearBanner: "{{ form.instance.get_see_hear_score_display|safe|default:dropdown_default|escapejs }}",
            handleTomFieldChanged(event) {
                this.updateIfMatch(event, "relative_size", "sizeBanner");
                this.updateIfMatch(event, "see_hear_score", "seeHearBanner");
            },
            updateIfMatch(event, eventFieldName, stateFieldName) {
                const sourceElem = event.detail.element;
                const isChildSource = $el.contains(sourceElem);
                const isFieldNameMatch = event.detail.fieldName.includes(eventFieldName);
                if (!isChildSource || !isFieldNameMatch) return;
                this[stateFieldName] = event.detail.html || "{{dropdown_default|escapejs}}";
            },
        }'
        {% endwith %}
        x-init="
            const collapseEl = $el.querySelector('.accordion-collapse');
            collapseEl.addEventListener('show.bs.collapse', () => openRoom = $el.id);
            collapseEl.addEventListener('shown.bs.collapse', () => {
                collapseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
            collapseEl.addEventListener('hide.bs.collapse', () => {
                const isClosingActiveRoom = openRoom === $el.id
                if (isClosingActiveRoom) openRoom = null;
            });
        "
    {# djlint:on #}
    @tom-select-changed.window="handleTomFieldChanged($event)"
    >
    <h2 class="accordion-header">
        <button class="accordion-button
            {% if form.errors %}
                bg-alert-danger text-alert-danger
            {% else %}
                bg-light
            {% endif %}
            m-0"
            type="button"
            {# djlint:off #}
            @click="
                const collapseEl = $el.closest('.accordion-item').querySelector('.accordion-collapse');
                new bootstrap.Collapse(collapseEl, { toggle: true });
            "
            {# djlint:on #}
            :class="{ 'collapsed': openRoom !== $el.closest('.accordion-item').id }"
            :aria-expanded="openRoom === $el.closest('.accordion-item').id">
            <div class="w-100"
                 x-show="openRoom !== $el.closest('.accordion-item').id"
                 x-cloak>
                <div class="d-flex flex-column w-100">
                    {% if form.errors %}
                        <div class="fw-bold text-danger mb-3">This room has errors. Click to review and fix.</div>
                    {% endif %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="h6 inline-block fw-bold" x-html='roomName || "Unnamed room"'></div>
                        <span class="pe-3 text-primary text-nowrap">
                            <i class="fas fa-edit"></i> Edit
                        </span>
                    </div>
                    <div class="row g-3">
                        <div class="col-5">
                            <div class="small text-muted mb-1 text-nowrap">
                                <i class="fa-solid fa-eye me-1"></i> Vis. & Aud.
                            </div>
                            <div x-html="seeHearBanner"></div>
                        </div>
                        <div class="col-7">
                            <div class="small text-muted mb-1 text-nowrap">
                                <i class="fa-solid fa-up-right-and-down-left-from-center me-1"></i> Size
                            </div>
                            <div x-html="sizeBanner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </button>
    </h2>
    <div class="accordion-collapse collapse"
         :class="{ 'show': openRoom === $el.closest('.accordion-item').id }"
         data-bs-parent="#roomsAccordion">
        <div class="accordion-body position-relative">
            <div class="col-auto position-absolute end-0 top-0 p-1">
                {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                </div>
                <div class="col">
                    <div class="row">
                        <div class="col-12">{{ form.name|as_crispy_field }}</div>
                        <div class="col-12">{{ form.relative_size|as_crispy_field }}</div>
                        <div class="col-12">{{ form.see_hear_score|as_crispy_field }}</div>
                    </div>
                    <div class="delete-room-container"></div>
                </div>
            </div>
        </div>
    </div>
