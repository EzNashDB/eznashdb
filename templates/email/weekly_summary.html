<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
    </head>
    <body style="font-family: sans-serif; max-width: 900px; margin: 20px;">
        <h2 style="margin-bottom: 10px;">Weekly Shul Updates</h2>
        <div style="background: #f8f9fa;
                    padding: 15px;
                    border-radius: 4px;
                    margin-bottom: 25px">
            <strong>{{ shuls|length }}</strong> shul(s) updated
            {% if deleted_shuls %}
                &nbsp;|&nbsp; <strong style="color: #dc3545;">{{ deleted_shuls|length }}</strong> shul(s) deleted
            {% endif %}
            {% if violations %}
                &nbsp;|&nbsp; <strong style="color: #856404;">{{ violations|length }}</strong> rate limit violation(s)
            {% endif %}
        </div>
        {% if shuls %}
            <h3 style="margin-top: 30px; margin-bottom: 15px;">Updated Shuls</h3>
            <table style="border-collapse: collapse; width: 100%; margin-bottom: 40px;">
                <thead>
                    <tr style="background: #e9ecef;">
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Shul</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Room</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 60px">Size</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 80px">Rating</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 120px">Updated</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 80px">Country</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shul in shuls %}
                        {% with room_count=shul.rooms|length|default:1 %}
                            {% if shul.rooms %}
                                {% for room in shul.rooms %}
                                    <tr style="{% if not forloop.first %}border-top: none;{% endif %}">
                                        {% if forloop.first %}
                                            <td rowspan="{{ room_count }}"
                                                style="vertical-align: top;
                                                       border: 1px solid #dee2e6;
                                                       padding: 10px;
                                                       font-weight: 500">
                                                <a href="{{ shul.map_url }}"
                                                   style="color: #0066cc;
                                                          text-decoration: none">{{ shul.name }}</a>
                                            </td>
                                        {% endif %}
                                        <td style="border: 1px solid #dee2e6; padding: 10px;">{{ room.name }}</td>
                                        <td style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">{{ room.size }}</td>
                                        <td style="border: 1px solid #dee2e6; padding: 10px;">{{ room.stars }}</td>
                                        {% if forloop.first %}
                                            <td rowspan="{{ room_count }}"
                                                style="vertical-align: top;
                                                       border: 1px solid #dee2e6;
                                                       padding: 10px;
                                                       font-size: 13px;
                                                       color: #666">
                                                {{ shul.updated_at|date:"M d, g:i a" }}
                                            </td>
                                            <td rowspan="{{ room_count }}"
                                                style="vertical-align: top;
                                                       border: 1px solid #dee2e6;
                                                       padding: 10px">{{ shul.country }}</td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td style="border: 1px solid #dee2e6; padding: 10px; font-weight: 500;">
                                        <a href="{{ shul.map_url }}"
                                           style="color: #0066cc;
                                                  text-decoration: none">{{ shul.name }}</a>
                                    </td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px; color: #999;">
                                        <em>(no rooms)</em>
                                    </td>
                                    <td style="border: 1px solid #dee2e6;
                                               padding: 10px;
                                               text-align: center;
                                               color: #999">-</td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px; color: #999;">-</td>
                                    <td style="border: 1px solid #dee2e6;
                                               padding: 10px;
                                               font-size: 13px;
                                               color: #666">{{ shul.updated_at|date:"M d, g:i a" }}</td>
                                    <td style="border: 1px solid #dee2e6; padding: 10px;">{{ shul.country }}</td>
                                </tr>
                            {% endif %}
                        {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
        {% if deleted_shuls %}
            <h3 style="color: #dc3545; margin-top: 30px; margin-bottom: 10px;">Deleted Shuls</h3>
            <p style="margin-bottom: 15px;">
                <a href="{{ deleted_shuls_admin_url }}" style="color: #0066cc;">View and manage in admin</a>
            </p>
            <table style="border-collapse: collapse; width: 100%; margin-bottom: 40px;">
                <thead>
                    <tr style="background: #fff3cd;">
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Shul</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Reason</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 120px">Deleted By</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 120px">Deleted</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 80px">Country</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shul in deleted_shuls %}
                        <tr>
                            <td style="border: 1px solid #dee2e6; padding: 10px; font-weight: 500;">{{ shul.name }}</td>
                            <td style="border: 1px solid #dee2e6; padding: 10px;">{{ shul.deletion_reason }}</td>
                            <td style="border: 1px solid #dee2e6; padding: 10px;">{{ shul.deleted_by }}</td>
                            <td style="border: 1px solid #dee2e6;
                                       padding: 10px;
                                       font-size: 13px;
                                       color: #666">{{ shul.deleted_at|date:"M d, g:i a" }}</td>
                            <td style="border: 1px solid #dee2e6; padding: 10px;">{{ shul.country }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
        {% if violations %}
            <h3 style="color: #856404; margin-top: 30px; margin-bottom: 15px;">Rate Limit Violations</h3>
            <table style="border-collapse: collapse; width: 100%; margin-bottom: 40px;">
                <thead>
                    <tr style="background: #fff3cd;">
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">IP Address</th>
                        <th style="border: 1px solid #dee2e6; padding: 10px; text-align: left;">Endpoint</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 60px">Count</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 140px">Status</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 120px">First</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 120px">Last</th>
                        <th style="border: 1px solid #dee2e6;
                                   padding: 10px;
                                   text-align: left;
                                   width: 150px">User</th>
                    </tr>
                </thead>
                <tbody>
                    {% for violation in violations %}
                        <tr>
                            <td style="border: 1px solid #dee2e6;
                                       padding: 10px;
                                       font-family: monospace">{{ violation.ip_address }}</td>
                            <td style="border: 1px solid #dee2e6; padding: 10px;">{{ violation.endpoint }}</td>
                            <td style="border: 1px solid #dee2e6; padding: 10px; text-align: center;">
                                {{ violation.violation_count }}
                            </td>
                            <td style="border: 1px solid #dee2e6; padding: 10px; font-size: 13px;">
                                {% if violation.is_permanent_ban %}
                                    <span style="color: #721c24; font-weight: 600;">üö´ PERMANENTLY BANNED</span>
                                {% elif violation.is_in_cooldown %}
                                    <span style="color: #721c24; font-weight: 500;">üö´ Blocked until {{ violation.cooldown_until|date:"M d, g:i a" }}</span>
                                {% elif violation.is_active %}
                                    <span style="color: #856404;">‚ö†Ô∏è Active (&lt;24hrs, counts toward escalation)</span>
                                {% else %}
                                    <span style="color: #666;">Inactive (&gt;24hrs old)</span>
                                {% endif %}
                            </td>
                            <td style="border: 1px solid #dee2e6;
                                       padding: 10px;
                                       font-size: 13px;
                                       color: #666">
                                {{ violation.first_violation_at|date:"M d, g:i a" }}
                            </td>
                            <td style="border: 1px solid #dee2e6;
                                       padding: 10px;
                                       font-size: 13px;
                                       color: #666">
                                {{ violation.last_violation_at|date:"M d, g:i a" }}
                            </td>
                            <td style="border: 1px solid #dee2e6; padding: 10px;">{{ violation.user_email }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
        <p style="color: #999;
                  font-size: 12px;
                  margin-top: 30px;
                  border-top: 1px solid #eee;
                  padding-top: 15px">Automated message from ezratnashim.com</p>
    </body>
</html>
